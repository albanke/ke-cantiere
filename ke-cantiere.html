<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KE Cantiere</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #0a0a0a;
    --carbon: #141414;
    --steel: #1e1e1e;
    --plate: #272727;
    --border: #333;
    --muted: #555;
    --mid: #888;
    --light: #ccc;
    --white: #edf5ee;
    --amber: #22c55e;
    --amber-dim: #15803d;
    --red: #ef4444;
    --green: #22c55e;
    --blue: #3b82f6;
    --text: #e8f0e8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Barlow', sans-serif;
    background: var(--black);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ─── NOISE TEXTURE OVERLAY ─── */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 9999; opacity: 0.4;
  }

  /* ─── HEADER ─── */
  header {
    background: var(--carbon);
    border-bottom: 3px solid var(--amber);
    padding: 0 2rem;
    display: flex;
    align-items: stretch;
    height: 64px;
    position: sticky; top: 0; z-index: 100;
  }

  .logo {
    display: flex; align-items: center; gap: 12px;
    margin-right: 3rem;
  }
  .logo-mark {
    width: 36px; height: 36px;
    background: var(--amber);
    clip-path: polygon(0 0, 100% 0, 100% 70%, 70% 100%, 0 100%);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900; font-size: 18px;
    color: #fff;
  }
  .logo-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 20px;
    letter-spacing: 0.08em;
    color: var(--white);
  }
  .logo-text span { color: var(--amber); }

  nav {
    display: flex; align-items: stretch; gap: 2px;
  }
  nav button {
    background: none; border: none; cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--mid);
    padding: 0 20px;
    border-bottom: 3px solid transparent;
    margin-bottom: -3px;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 8px;
  }
  nav button:hover { color: var(--light); }
  nav button.active { color: var(--amber); border-bottom-color: var(--amber); }
  nav button .icon { font-size: 16px; }

  .header-right {
    margin-left: auto;
    display: flex; align-items: center; gap: 16px;
  }
  .date-chip {
    font-size: 12px; color: var(--mid);
    letter-spacing: 0.05em; font-weight: 500;
  }

  /* ─── MAIN LAYOUT ─── */
  main {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .page { display: none; animation: fadeIn 0.2s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

  /* ─── PAGE HEADER ─── */
  .page-header {
    display: flex; align-items: flex-end; justify-content: space-between;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .page-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 42px; font-weight: 900;
    line-height: 1; letter-spacing: -0.01em;
    color: var(--white);
  }
  .page-title span { color: var(--amber); }
  .page-subtitle { font-size: 13px; color: var(--muted); margin-top: 4px; letter-spacing: 0.05em; text-transform: uppercase; }

  /* ─── BUTTONS ─── */
  .btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 10px 20px; border: none; cursor: pointer;
    display: inline-flex; align-items: center; gap: 8px;
    transition: all 0.15s;
  }
  .btn-primary {
    background: var(--amber); color: #fff;
    clip-path: polygon(0 0, 100% 0, 100% 70%, 93% 100%, 0 100%);
  }
  .btn-primary:hover { background: #fbbf24; }
  .btn-ghost {
    background: var(--plate); color: var(--light); border: 1px solid var(--border);
  }
  .btn-ghost:hover { border-color: var(--amber); color: var(--amber); }
  .btn-danger { background: var(--red); color: white; }
  .btn-sm { font-size: 11px; padding: 6px 14px; }

  /* ─── STATS ROW ─── */
  .stats-row {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px; margin-bottom: 2rem;
  }
  .stat-card {
    background: var(--carbon);
    border: 1px solid var(--border);
    border-top: 3px solid var(--amber);
    padding: 1.2rem 1.5rem;
    position: relative; overflow: hidden;
  }
  .stat-card::after {
    content: '';
    position: absolute; bottom: -20px; right: -20px;
    width: 80px; height: 80px;
    background: var(--amber);
    opacity: 0.03; border-radius: 50%;
  }
  .stat-num {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 48px; font-weight: 900; line-height: 1;
    color: var(--white);
  }
  .stat-label {
    font-size: 11px; color: var(--muted); letter-spacing: 0.1em;
    text-transform: uppercase; margin-top: 4px;
  }

  /* ─── TABLE ─── */
  .table-wrap {
    background: var(--carbon);
    border: 1px solid var(--border);
    overflow: hidden;
  }
  .table-toolbar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--steel);
  }
  .search-box {
    display: flex; align-items: center; gap: 10px;
    background: var(--plate); border: 1px solid var(--border);
    padding: 8px 14px;
  }
  .search-box input {
    background: none; border: none; outline: none;
    color: var(--text); font-size: 13px; width: 220px;
    font-family: 'Barlow', sans-serif;
  }
  .search-box input::placeholder { color: var(--muted); }

  table { width: 100%; border-collapse: collapse; }
  thead tr { background: var(--steel); }
  th {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); text-align: left;
    padding: 12px 16px; border-bottom: 1px solid var(--border);
  }
  td {
    padding: 13px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 14px; color: var(--light);
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(34,197,94,0.04); }

  .badge {
    display: inline-flex; align-items: center;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 3px 10px;
    border: 1px solid;
  }
  .badge-green { color: var(--green); border-color: rgba(34,197,94,0.3); background: rgba(34,197,94,0.07); }
  .badge-red { color: var(--red); border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.07); }
  .badge-amber { color: #86efac; border-color: rgba(134,239,172,0.3); background: rgba(134,239,172,0.07); }
  .badge-blue { color: var(--blue); border-color: rgba(59,130,246,0.3); background: rgba(59,130,246,0.07); }

  /* ─── MODAL ─── */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    z-index: 200; align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--steel);
    border: 1px solid var(--border);
    border-top: 3px solid var(--amber);
    width: min(600px, 95vw);
    max-height: 90vh; overflow-y: auto;
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn { from { opacity: 0; transform: scale(0.96) translateY(10px); } to { opacity: 1; transform: none; } }
  .modal-header {
    padding: 1.5rem 2rem 1rem;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .modal-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 22px; font-weight: 700; letter-spacing: 0.05em;
  }
  .modal-close {
    background: none; border: none; color: var(--muted);
    font-size: 20px; cursor: pointer; padding: 4px 8px;
    transition: color 0.15s;
  }
  .modal-close:hover { color: var(--red); }
  .modal-body { padding: 1.5rem 2rem 2rem; }

  /* ─── FORM ─── */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1 / -1; }
  label {
    font-size: 11px; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--muted);
  }
  input[type=text], input[type=date], input[type=tel], input[type=number], select, textarea {
    background: var(--plate); border: 1px solid var(--border);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 14px;
    padding: 10px 14px; outline: none; transition: border-color 0.15s;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--amber); }
  select option { background: var(--plate); }

  .form-actions {
    display: flex; gap: 12px; justify-content: flex-end;
    margin-top: 1.5rem; padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  /* ─── DASHBOARD ─── */
  .dash-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
    margin-top: 1.5rem;
  }
  .dash-card {
    background: var(--carbon);
    border: 1px solid var(--border);
    padding: 1.5rem;
  }
  .dash-card-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 1rem;
    display: flex; align-items: center; gap: 8px;
  }
  .dash-card-title::before {
    content: ''; display: block;
    width: 16px; height: 2px; background: var(--amber);
  }

  /* Cantiere cards */
  .cantiere-cards {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }
  .cantiere-card {
    background: var(--carbon); border: 1px solid var(--border);
    padding: 1.5rem; cursor: pointer;
    transition: all 0.15s; position: relative; overflow: hidden;
  }
  .cantiere-card::before {
    content: '';
    position: absolute; left: 0; top: 0; bottom: 0;
    width: 4px; background: var(--amber);
  }
  .cantiere-card:hover { border-color: var(--amber); background: var(--steel); }
  .cantiere-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 22px; font-weight: 700; color: var(--white);
    margin-bottom: 8px;
  }
  .cantiere-meta { font-size: 12px; color: var(--muted); }

  /* Presenze */
  .presenza-date-header {
    display: flex; align-items: center; gap: 16px;
    background: var(--carbon); border: 1px solid var(--border);
    padding: 1rem 1.5rem; margin-bottom: 1rem;
  }
  .presenza-date-header input[type=date] {
    flex: 1; max-width: 200px;
  }

  .presenza-table-wrap { background: var(--carbon); border: 1px solid var(--border); }
  .presenza-row {
    display: grid;
    grid-template-columns: 1fr 160px 80px 80px 80px 100px;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    gap: 12px;
  }
  .presenza-row:last-child { border-bottom: none; }
  .presenza-row.header {
    background: var(--steel);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted);
  }
  .presenza-row:not(.header):hover { background: rgba(34,197,94,0.04); }
  .operaio-name { font-weight: 500; color: var(--white); font-size: 14px; }
  .operaio-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }

  .toggle-btn {
    width: 32px; height: 32px; border: 2px solid var(--border);
    background: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 14px; transition: all 0.1s; color: var(--muted);
  }
  .toggle-btn:hover { border-color: var(--amber); }
  .toggle-btn.active { background: var(--amber); border-color: var(--amber); color: #fff; font-weight: bold; }

  .ore-input {
    background: var(--plate); border: 1px solid var(--border);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 14px;
    padding: 6px 10px; width: 60px; text-align: center; outline: none;
  }
  .ore-input:focus { border-color: var(--amber); }

  /* Segnalazioni */
  .segn-card {
    background: var(--carbon); border: 1px solid var(--border);
    border-left: 4px solid var(--amber);
    padding: 1.2rem 1.5rem; margin-bottom: 12px;
    display: grid; grid-template-columns: 1fr auto;
    gap: 12px; align-items: start;
  }
  .segn-card.alta { border-left-color: var(--red); }
  .segn-card.bassa { border-left-color: var(--blue); }
  .segn-title { font-weight: 600; color: var(--white); margin-bottom: 4px; }
  .segn-body { font-size: 13px; color: var(--mid); }
  .segn-meta { font-size: 11px; color: var(--muted); margin-top: 8px; letter-spacing: 0.05em; }

  /* empty state */
  .empty {
    text-align: center; padding: 4rem 2rem;
    color: var(--muted);
  }
  .empty-icon { font-size: 48px; margin-bottom: 1rem; opacity: 0.4; }
  .empty-text { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; }

  /* Responsive */
  @media (max-width: 768px) {
    main { padding: 1rem; }
    .dash-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .presenza-row { grid-template-columns: 1fr 80px 80px; }
    .presenza-row > :nth-child(2), .presenza-row > :nth-child(5), .presenza-row > :nth-child(6) { display: none; }
  }

  /* notifications */
  .toast {
    position: fixed; bottom: 2rem; right: 2rem;
    background: var(--amber); color: #fff;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 0.05em;
    padding: 12px 20px;
    clip-path: polygon(0 0, 100% 0, 100% 70%, 95% 100%, 0 100%);
    z-index: 999; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards;
  }
  @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: none; } }
  @keyframes toastOut { to { opacity: 0; transform: translateY(20px); } }

  /* matr badge */
  .matr {
    display: inline-block; width: 28px; height: 28px;
    background: var(--plate); border: 1px solid var(--border);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px; font-weight: 700; color: var(--amber);
    text-align: center; line-height: 28px;
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-mark">KE</div>
    <div class="logo-text">KE<span>·</span>CANTIERE</div>
  </div>
  <nav>
    <button class="active" data-page="dashboard" onclick="showPage('dashboard')">
      <span class="icon">⊞</span> Dashboard
    </button>
    <button data-page="presenze" onclick="showPage('presenze')">
      <span class="icon">◷</span> Presenze
    </button>
    <button data-page="operai" onclick="showPage('operai')">
      <span class="icon">◉</span> Operai
    </button>
    <button data-page="cantieri" onclick="showPage('cantieri')">
      <span class="icon">⬡</span> Cantieri
    </button>
    <button data-page="segnalazioni" onclick="showPage('segnalazioni')">
      <span class="icon">⚑</span> Segnalazioni
    </button>
  </nav>
  <div class="header-right">
    <span class="date-chip" id="date-display"></span>
  </div>
</header>

<main>

  <!-- ═══ DASHBOARD ═══ -->
  <div id="page-dashboard" class="page active">
    <div class="page-header">
      <div>
        <div class="page-title">Dashboard <span>.</span></div>
        <div class="page-subtitle">Riepilogo giornaliero</div>
      </div>
      <button class="btn btn-primary" onclick="showPage('presenze')">
        <span>+</span> Nuova Presenza
      </button>
    </div>

    <div class="stats-row" id="dash-stats"></div>

    <div class="dash-grid">
      <div class="dash-card">
        <div class="dash-card-title">Cantieri Attivi</div>
        <div id="dash-cantieri"></div>
      </div>
      <div class="dash-card">
        <div class="dash-card-title">Operai per Contratto</div>
        <div id="dash-contratti"></div>
      </div>
    </div>
  </div>

  <!-- ═══ PRESENZE ═══ -->
  <div id="page-presenze" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Presenze <span>.</span></div>
        <div class="page-subtitle">Registrazione giornaliera</div>
      </div>
      <button class="btn btn-primary" onclick="salvaPresenze()">
        <span>✓</span> Salva Giornata
      </button>
    </div>

    <div class="presenza-date-header">
      <label style="margin:0; white-space:nowrap">Data</label>
      <input type="date" id="presenza-date" onchange="renderPresenze()">
      <label style="margin:0; white-space:nowrap">Cantiere</label>
      <select id="presenza-cantiere" onchange="renderPresenze()" style="max-width:220px">
        <option value="">— Seleziona —</option>
      </select>
    </div>

    <div id="presenze-content"></div>
  </div>

  <!-- ═══ OPERAI ═══ -->
  <div id="page-operai" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Operai <span>.</span></div>
        <div class="page-subtitle" id="operai-count"></div>
      </div>
      <button class="btn btn-primary" onclick="openModalOperaio()">
        <span>+</span> Nuovo Operaio
      </button>
    </div>

    <div class="table-wrap">
      <div class="table-toolbar">
        <div class="search-box">
          <span style="color:var(--muted)">⌕</span>
          <input type="text" placeholder="Cerca operaio..." oninput="filterOperai(this.value)">
        </div>
        <div style="display:flex;gap:8px">
          <select id="filter-stato" onchange="renderOperai()" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-size:13px;outline:none">
            <option value="">Tutti gli stati</option>
            <option value="attivo">Attivi</option>
            <option value="inattivo">Inattivi</option>
          </select>
          <select id="filter-contratto" onchange="renderOperai()" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-size:13px;outline:none">
            <option value="">Tutti i contratti</option>
            <option value="cassa_edile">Cassa Edile</option>
            <option value="metalmeccanico">Metalmeccanico</option>
          </select>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Matr.</th>
            <th>Nome</th>
            <th>Contratto</th>
            <th>Mansione</th>
            <th>Telefono</th>
            <th>Stato</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="operai-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ═══ CANTIERI ═══ -->
  <div id="page-cantieri" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Cantieri <span>.</span></div>
        <div class="page-subtitle" id="cantieri-count"></div>
      </div>
      <button class="btn btn-primary" onclick="openModalCantiere()">
        <span>+</span> Nuovo Cantiere
      </button>
    </div>
    <div class="cantiere-cards" id="cantiere-cards"></div>
  </div>

  <!-- ═══ SEGNALAZIONI ═══ -->
  <div id="page-segnalazioni" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Segnalazioni <span>.</span></div>
        <div class="page-subtitle">Problemi e note dal campo</div>
      </div>
      <button class="btn btn-primary" onclick="openModalSegnalazione()">
        <span>+</span> Nuova Segnalazione
      </button>
    </div>
    <div id="segnalazioni-list"></div>
  </div>

</main>

<!-- ═══ MODAL OPERAIO ═══ -->
<div class="modal-overlay" id="modal-operaio">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-operaio-title">Nuovo Operaio</div>
      <button class="modal-close" onclick="closeModal('modal-operaio')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full">
          <label>Nome Completo</label>
          <input type="text" id="op-nome" placeholder="Cognome Nome">
        </div>
        <div class="form-group">
          <label>Matricola</label>
          <input type="text" id="op-matr" placeholder="Es. 42">
        </div>
        <div class="form-group">
          <label>Contratto</label>
          <select id="op-contratto">
            <option value="cassa_edile">Cassa Edile</option>
            <option value="metalmeccanico">Metalmeccanico</option>
          </select>
        </div>
        <div class="form-group">
          <label>Mansione</label>
          <input type="text" id="op-mansione" placeholder="Es. Muratore">
        </div>
        <div class="form-group">
          <label>Telefono</label>
          <input type="tel" id="op-tel" placeholder="+39 ...">
        </div>
        <div class="form-group">
          <label>Cantiere Default</label>
          <select id="op-cantiere-default">
            <option value="">— Nessuno —</option>
          </select>
        </div>
        <div class="form-group">
          <label>Stato</label>
          <select id="op-stato">
            <option value="attivo">Attivo</option>
            <option value="inattivo">Inattivo</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeModal('modal-operaio')">Annulla</button>
        <button class="btn btn-primary" onclick="salvaOperaio()">Salva</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ MODAL CANTIERE ═══ -->
<div class="modal-overlay" id="modal-cantiere">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-cantiere-title">Nuovo Cantiere</div>
      <button class="modal-close" onclick="closeModal('modal-cantiere')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full">
          <label>Nome Cantiere</label>
          <input type="text" id="cant-nome" placeholder="Es. Via Roma 12 - Milano">
        </div>
        <div class="form-group full">
          <label>Indirizzo</label>
          <input type="text" id="cant-indirizzo" placeholder="Indirizzo completo">
        </div>
        <div class="form-group">
          <label>Stato</label>
          <select id="cant-stato">
            <option value="attivo">Attivo</option>
            <option value="completato">Completato</option>
            <option value="sospeso">Sospeso</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Note</label>
          <textarea id="cant-note" rows="3" placeholder="Note sul cantiere..." style="resize:vertical"></textarea>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeModal('modal-cantiere')">Annulla</button>
        <button class="btn btn-primary" onclick="salvaCantiere()">Salva</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ MODAL SEGNALAZIONE ═══ -->
<div class="modal-overlay" id="modal-segnalazione">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Nuova Segnalazione</div>
      <button class="modal-close" onclick="closeModal('modal-segnalazione')">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full">
          <label>Titolo</label>
          <input type="text" id="segn-titolo" placeholder="Descrizione breve">
        </div>
        <div class="form-group">
          <label>Cantiere</label>
          <select id="segn-cantiere"></select>
        </div>
        <div class="form-group">
          <label>Priorità</label>
          <select id="segn-priorita">
            <option value="media">Media</option>
            <option value="alta">Alta</option>
            <option value="bassa">Bassa</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Descrizione</label>
          <textarea id="segn-desc" rows="4" placeholder="Dettagli della segnalazione..." style="resize:vertical"></textarea>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeModal('modal-segnalazione')">Annulla</button>
        <button class="btn btn-primary" onclick="salvaSegnalazione()">Segnala</button>
      </div>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════
//  DATA (loaded from embedded JSON)
// ══════════════════════════════════════════
const RAW_DATA = {"operai":[{"name":"MOHAMED KHALIL ABOUELAILA ABDELRAHMAN","contratto":"cassa_edile","matr":"4","id":"w29b51fad","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"MOBARAK ABOUELELA","contratto":"cassa_edile","matr":"3","id":"w8c7334f1","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"ELSAYED OMAR SAID AHMED MOHAMED","contratto":"cassa_edile","matr":"27","id":"wa4d5159f","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"CASSINELLI GIANMARIO","contratto":"cassa_edile","matr":"13","id":"w8cdf3a4c","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"FATHY ESMAEIL EL FAYOUMY HAITHM","contratto":"cassa_edile","matr":"","id":"w36253b39","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"MANNINO DANIELA MARTINA","contratto":"metalmeccanico","matr":"","id":"wacd0d187","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"CAPELLETTI MASSIMO","contratto":"metalmeccanico","matr":"","id":"w43517b7d","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"DI DONATO MARINA ALEJANDRA","contratto":"metalmeccanico","matr":"","id":"w6f5b326a","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"CAPELLETTI PATRIZIO","contratto":"metalmeccanico","matr":"","id":"w24702665","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"STURNIOLO CARMELO","contratto":"metalmeccanico","matr":"","id":"wa4317b06","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"IANNELLO PINO","contratto":"metalmeccanico","matr":"","id":"w83f28c2e","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"IANNELLO MIRKO","contratto":"metalmeccanico","matr":"","id":"w42c5bcb8","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"OSMAN OSMAN IBRAHIM","contratto":"cassa_edile","matr":"","id":"w37b5a7e3","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"ABDELHAK ZAHRAN","contratto":"cassa_edile","matr":"","id":"w1e79b1ec","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"MILED HNEYDI","contratto":"cassa_edile","matr":"","id":"w80b4eae5","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"BOUACIDA NASSIM","contratto":"cassa_edile","matr":"","id":"wbb53f793","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"CAPELLETTI FABIO","contratto":"metalmeccanico","matr":"","id":"wcf82f0e4","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"ELMOLLA MOSTAFA FATHI","contratto":"cassa_edile","matr":"","id":"w4a0b2c56","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"HMAIDI SEIFEDDINE","contratto":"cassa_edile","matr":"","id":"w1cfff31c","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"}],"cantieri":[{"id":"c001","name":"Rozzano","indirizzo":"","stato":"attivo","note":""},{"id":"c002","name":"Sesto San Giovanni","indirizzo":"","stato":"attivo","note":""},{"id":"c003","name":"Via Tofano","indirizzo":"","stato":"attivo","note":""}],"giornate":[],"registrazioni":[],"segnalazioni":[]};

let db = JSON.parse(localStorage.getItem('ke_cantiere_db') || JSON.stringify(RAW_DATA));

function saveDB() {
  localStorage.setItem('ke_cantiere_db', JSON.stringify(db));
}

// ══════════════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════════════
let currentSearch = '';
let editingId = null;

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelector(`[data-page="${name}"]`).classList.add('active');
  
  if (name === 'dashboard') renderDashboard();
  if (name === 'operai') renderOperai();
  if (name === 'cantieri') renderCantieri();
  if (name === 'presenze') renderPresenze();
  if (name === 'segnalazioni') renderSegnalazioni();
}

// ══════════════════════════════════════════
//  DATE
// ══════════════════════════════════════════
function todayStr() {
  return new Date().toISOString().split('T')[0];
}
function formatDate(s) {
  if (!s) return '';
  const d = new Date(s + 'T00:00:00');
  return d.toLocaleDateString('it-IT', { weekday:'short', day:'numeric', month:'short', year:'numeric' });
}

// ══════════════════════════════════════════
//  DASHBOARD
// ══════════════════════════════════════════
function renderDashboard() {
  const attivi = db.operai.filter(o => o.stato === 'attivo').length;
  const cantieri = db.cantieri.filter(c => c.stato === 'attivo').length;
  const oggi = db.giornate.filter(g => g.data === todayStr());
  const segnalazioni = db.segnalazioni.filter(s => s.aperta !== false).length;

  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-num">${attivi}</div>
      <div class="stat-label">Operai Attivi</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">${cantieri}</div>
      <div class="stat-label">Cantieri Attivi</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">${db.giornate.length}</div>
      <div class="stat-label">Presenze Totali</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">${segnalazioni}</div>
      <div class="stat-label">Segnalazioni Aperte</div>
    </div>
  `;

  document.getElementById('dash-cantieri').innerHTML = db.cantieri.map(c => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-weight:500;color:var(--white)">${c.name}</div>
        <div style="font-size:11px;color:var(--muted)">${c.indirizzo || 'Indirizzo non specificato'}</div>
      </div>
      <span class="badge badge-${c.stato === 'attivo' ? 'green' : c.stato === 'sospeso' ? 'amber' : 'blue'}">${c.stato}</span>
    </div>
  `).join('') || '<div class="empty"><div class="empty-text">Nessun cantiere</div></div>';

  const conteggi = {};
  db.operai.filter(o => o.stato === 'attivo').forEach(o => {
    const k = o.contratto === 'cassa_edile' ? 'Cassa Edile' : 'Metalmeccanico';
    conteggi[k] = (conteggi[k] || 0) + 1;
  });
  const tot = db.operai.filter(o => o.stato === 'attivo').length;
  document.getElementById('dash-contratti').innerHTML = Object.entries(conteggi).map(([k, v]) => `
    <div style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-size:13px;color:var(--light)">${k}</span>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--white)">${v}</span>
      </div>
      <div style="height:4px;background:var(--plate)">
        <div style="height:100%;width:${Math.round(v/tot*100)}%;background:var(--amber)"></div>
      </div>
    </div>
  `).join('');
}

// ══════════════════════════════════════════
//  OPERAI
// ══════════════════════════════════════════
function filterOperai(v) {
  currentSearch = v.toLowerCase();
  renderOperai();
}

function renderOperai() {
  const stato = document.getElementById('filter-stato').value;
  const contratto = document.getElementById('filter-contratto').value;
  
  let lista = db.operai.filter(o => {
    if (stato && o.stato !== stato) return false;
    if (contratto && o.contratto !== contratto) return false;
    if (currentSearch && !o.name.toLowerCase().includes(currentSearch)) return false;
    return true;
  });

  document.getElementById('operai-count').textContent = `${lista.length} operai`;
  
  if (!lista.length) {
    document.getElementById('operai-tbody').innerHTML = `<tr><td colspan="7"><div class="empty"><div class="empty-icon">◉</div><div class="empty-text">Nessun operaio trovato</div></div></td></tr>`;
    return;
  }

  document.getElementById('operai-tbody').innerHTML = lista.map(o => `
    <tr>
      <td><div class="matr">${o.matr || '—'}</div></td>
      <td style="font-weight:500;color:var(--white)">${titleCase(o.name)}</td>
      <td><span class="badge badge-${o.contratto === 'cassa_edile' ? 'amber' : 'blue'}">${o.contratto === 'cassa_edile' ? 'Cassa Edile' : 'Metalmeccanico'}</span></td>
      <td style="color:var(--muted)">${o.mansione || '—'}</td>
      <td style="color:var(--muted)">${o.tel || '—'}</td>
      <td><span class="badge badge-${o.stato === 'attivo' ? 'green' : 'red'}">${o.stato}</span></td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" onclick="openModalOperaio('${o.id}')">Modifica</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function openModalOperaio(id = null) {
  editingId = id;
  const modal = document.getElementById('modal-operaio');
  const title = document.getElementById('modal-operaio-title');
  
  // populate cantiere select
  const sel = document.getElementById('op-cantiere-default');
  sel.innerHTML = '<option value="">— Nessuno —</option>' + 
    db.cantieri.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

  if (id) {
    const o = db.operai.find(x => x.id === id);
    title.textContent = 'Modifica Operaio';
    document.getElementById('op-nome').value = o.name;
    document.getElementById('op-matr').value = o.matr;
    document.getElementById('op-contratto').value = o.contratto;
    document.getElementById('op-mansione').value = o.mansione;
    document.getElementById('op-tel').value = o.tel;
    document.getElementById('op-cantiere-default').value = o.cantiereDefault;
    document.getElementById('op-stato').value = o.stato;
  } else {
    title.textContent = 'Nuovo Operaio';
    document.getElementById('op-nome').value = '';
    document.getElementById('op-matr').value = '';
    document.getElementById('op-contratto').value = 'cassa_edile';
    document.getElementById('op-mansione').value = '';
    document.getElementById('op-tel').value = '';
    document.getElementById('op-cantiere-default').value = '';
    document.getElementById('op-stato').value = 'attivo';
  }
  
  modal.classList.add('open');
}

function salvaOperaio() {
  const nome = document.getElementById('op-nome').value.trim();
  if (!nome) { alert('Inserisci il nome'); return; }
  
  const data = {
    name: nome.toUpperCase(),
    matr: document.getElementById('op-matr').value.trim(),
    contratto: document.getElementById('op-contratto').value,
    mansione: document.getElementById('op-mansione').value.trim(),
    tel: document.getElementById('op-tel').value.trim(),
    cantiereDefault: document.getElementById('op-cantiere-default').value,
    stato: document.getElementById('op-stato').value,
  };

  if (editingId) {
    const idx = db.operai.findIndex(o => o.id === editingId);
    db.operai[idx] = { ...db.operai[idx], ...data };
  } else {
    db.operai.push({ ...data, id: 'w' + Math.random().toString(16).slice(2,10) });
  }

  saveDB();
  closeModal('modal-operaio');
  renderOperai();
  toast(editingId ? 'Operaio aggiornato' : 'Operaio aggiunto');
}

// ══════════════════════════════════════════
//  CANTIERI
// ══════════════════════════════════════════
function renderCantieri() {
  const lista = db.cantieri;
  document.getElementById('cantieri-count').textContent = `${lista.length} cantieri`;
  
  document.getElementById('cantiere-cards').innerHTML = lista.map(c => `
    <div class="cantiere-card" onclick="openModalCantiere('${c.id}')">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
        <div class="cantiere-name">${c.name}</div>
        <span class="badge badge-${c.stato === 'attivo' ? 'green' : c.stato === 'sospeso' ? 'amber' : 'blue'}">${c.stato}</span>
      </div>
      <div class="cantiere-meta">${c.indirizzo || 'Indirizzo da definire'}</div>
      ${c.note ? `<div class="cantiere-meta" style="margin-top:8px">${c.note}</div>` : ''}
    </div>
  `).join('');
}

function openModalCantiere(id = null) {
  editingId = id;
  const title = document.getElementById('modal-cantiere-title');
  
  if (id) {
    const c = db.cantieri.find(x => x.id === id);
    title.textContent = 'Modifica Cantiere';
    document.getElementById('cant-nome').value = c.name;
    document.getElementById('cant-indirizzo').value = c.indirizzo;
    document.getElementById('cant-stato').value = c.stato;
    document.getElementById('cant-note').value = c.note;
  } else {
    title.textContent = 'Nuovo Cantiere';
    document.getElementById('cant-nome').value = '';
    document.getElementById('cant-indirizzo').value = '';
    document.getElementById('cant-stato').value = 'attivo';
    document.getElementById('cant-note').value = '';
  }
  
  document.getElementById('modal-cantiere').classList.add('open');
}

function salvaCantiere() {
  const nome = document.getElementById('cant-nome').value.trim();
  if (!nome) { alert('Inserisci il nome'); return; }
  
  const data = {
    name: nome,
    indirizzo: document.getElementById('cant-indirizzo').value.trim(),
    stato: document.getElementById('cant-stato').value,
    note: document.getElementById('cant-note').value.trim(),
  };

  if (editingId) {
    const idx = db.cantieri.findIndex(c => c.id === editingId);
    db.cantieri[idx] = { ...db.cantieri[idx], ...data };
  } else {
    db.cantieri.push({ ...data, id: 'c' + Date.now() });
  }

  saveDB();
  closeModal('modal-cantiere');
  renderCantieri();
  toast(editingId ? 'Cantiere aggiornato' : 'Cantiere aggiunto');
}

// ══════════════════════════════════════════
//  PRESENZE
// ══════════════════════════════════════════
function initPresenze() {
  document.getElementById('presenza-date').value = todayStr();
  const sel = document.getElementById('presenza-cantiere');
  sel.innerHTML = '<option value="">— Seleziona cantiere —</option>' +
    db.cantieri.filter(c => c.stato === 'attivo').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function renderPresenze() {
  const data = document.getElementById('presenza-date').value;
  const cantId = document.getElementById('presenza-cantiere').value;
  const container = document.getElementById('presenze-content');

  if (!cantId) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">◷</div><div class="empty-text">Seleziona un cantiere</div></div>';
    return;
  }

  // Get existing registrations for this date+cantiere
  const existing = {};
  db.giornate.filter(g => g.data === data && g.cantiere === cantId).forEach(g => {
    existing[g.operaio] = g;
  });

  const operaiAttivi = db.operai.filter(o => o.stato === 'attivo');
  
  container.innerHTML = `
    <div class="presenza-table-wrap">
      <div class="presenza-row header">
        <div>Operaio</div>
        <div>Contratto</div>
        <div>Presente</div>
        <div>Ore</div>
        <div>Straord.</div>
        <div>Note</div>
      </div>
      ${operaiAttivi.map(o => {
        const g = existing[o.id] || {};
        const presente = !!g.presente;
        return `
        <div class="presenza-row" id="row-${o.id}">
          <div>
            <div class="operaio-name">${titleCase(o.name)}</div>
            <div class="operaio-meta">${o.matr ? 'Matr. ' + o.matr : ''} ${o.mansione || ''}</div>
          </div>
          <div><span class="badge badge-${o.contratto === 'cassa_edile' ? 'amber' : 'blue'}" style="font-size:10px">${o.contratto === 'cassa_edile' ? 'C.E.' : 'M.M.'}</span></div>
          <div>
            <button class="toggle-btn ${presente ? 'active' : ''}" id="pres-${o.id}" onclick="togglePresenza('${o.id}')">
              ${presente ? '✓' : ''}
            </button>
          </div>
          <div>
            <input class="ore-input" type="number" id="ore-${o.id}" min="0" max="24" step="0.5" value="${g.ore || 8}" placeholder="8">
          </div>
          <div>
            <input class="ore-input" type="number" id="str-${o.id}" min="0" max="12" step="0.5" value="${g.straordinari || 0}" placeholder="0">
          </div>
          <div>
            <input type="text" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:6px 10px;font-size:12px;width:100%;outline:none" id="note-${o.id}" value="${g.note || ''}" placeholder="—">
          </div>
        </div>
      `}).join('')}
    </div>
  `;
}

function togglePresenza(opId) {
  const btn = document.getElementById('pres-' + opId);
  const isActive = btn.classList.contains('active');
  btn.classList.toggle('active');
  btn.textContent = isActive ? '' : '✓';
}

function salvaPresenze() {
  const data = document.getElementById('presenza-date').value;
  const cantId = document.getElementById('presenza-cantiere').value;
  if (!cantId || !data) { alert('Seleziona data e cantiere'); return; }

  const operaiAttivi = db.operai.filter(o => o.stato === 'attivo');
  
  // Remove existing for this date+cantiere
  db.giornate = db.giornate.filter(g => !(g.data === data && g.cantiere === cantId));

  operaiAttivi.forEach(o => {
    const presente = document.getElementById('pres-' + o.id)?.classList.contains('active');
    if (presente) {
      db.giornate.push({
        id: 'g' + Date.now() + o.id,
        data, cantiere: cantId, operaio: o.id,
        presente: true,
        ore: parseFloat(document.getElementById('ore-' + o.id)?.value || 8),
        straordinari: parseFloat(document.getElementById('str-' + o.id)?.value || 0),
        note: document.getElementById('note-' + o.id)?.value || ''
      });
    }
  });

  saveDB();
  renderDashboard();
  toast('Presenze salvate ✓');
}

// ══════════════════════════════════════════
//  SEGNALAZIONI
// ══════════════════════════════════════════
function renderSegnalazioni() {
  const lista = db.segnalazioni;
  const container = document.getElementById('segnalazioni-list');
  
  if (!lista.length) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">⚑</div><div class="empty-text">Nessuna segnalazione</div></div>';
    return;
  }

  container.innerHTML = lista.map(s => {
    const cantiere = db.cantieri.find(c => c.id === s.cantiere);
    return `
    <div class="segn-card ${s.priorita === 'alta' ? 'alta' : s.priorita === 'bassa' ? 'bassa' : ''}">
      <div>
        <div class="segn-title">${s.titolo}</div>
        <div class="segn-body">${s.desc || ''}</div>
        <div class="segn-meta">
          <span class="badge badge-${s.priorita === 'alta' ? 'red' : s.priorita === 'bassa' ? 'blue' : 'amber'}" style="margin-right:8px">${s.priorita}</span>
          ${cantiere ? cantiere.name : ''} — ${formatDate(s.data)}
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="chiudiSegnalazione('${s.id}')">Chiudi</button>
    </div>
  `}).join('');
}

function openModalSegnalazione() {
  const sel = document.getElementById('segn-cantiere');
  sel.innerHTML = '<option value="">— Nessuno —</option>' +
    db.cantieri.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('segn-titolo').value = '';
  document.getElementById('segn-desc').value = '';
  document.getElementById('segn-priorita').value = 'media';
  document.getElementById('modal-segnalazione').classList.add('open');
}

function salvaSegnalazione() {
  const titolo = document.getElementById('segn-titolo').value.trim();
  if (!titolo) { alert('Inserisci un titolo'); return; }
  
  db.segnalazioni.push({
    id: 's' + Date.now(),
    titolo,
    desc: document.getElementById('segn-desc').value.trim(),
    cantiere: document.getElementById('segn-cantiere').value,
    priorita: document.getElementById('segn-priorita').value,
    data: todayStr(),
    aperta: true,
  });

  saveDB();
  closeModal('modal-segnalazione');
  renderSegnalazioni();
  toast('Segnalazione registrata');
}

function chiudiSegnalazione(id) {
  db.segnalazioni = db.segnalazioni.filter(s => s.id !== id);
  saveDB();
  renderSegnalazioni();
  toast('Segnalazione chiusa');
}

// ══════════════════════════════════════════
//  UTILS
// ══════════════════════════════════════════
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function titleCase(str) {
  return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ══════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════
const now = new Date();
document.getElementById('date-display').textContent = now.toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long', year:'numeric' });

renderDashboard();
initPresenze();
</script>
</body>
</html>
