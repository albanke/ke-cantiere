<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KE Cantiere</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #0a0a0a;
    --carbon: #141414;
    --steel: #1e1e1e;
    --plate: #272727;
    --border: #333;
    --muted: #555;
    --mid: #888;
    --light: #ccc;
    --white: #edf5ee;
    --amber: #22c55e;
    --amber-dim: #15803d;
    --red: #ef4444;
    --green: #22c55e;
    --blue: #3b82f6;
    --text: #e8f0e8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Barlow', sans-serif;
    background: var(--black);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0; opacity: 0.4;
  }

  /* ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ */
  #login-screen {
    position: fixed; inset: 0;
    background: var(--black);
    display: flex; align-items: center; justify-content: center;
    z-index: 500;
    animation: fadeIn 0.4s ease;
  }
  #login-screen.hidden { display: none; }

  .login-bg {
    position: absolute; inset: 0;
    background: 
      linear-gradient(135deg, rgba(34,197,94,0.03) 0%, transparent 50%),
      repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(34,197,94,0.02) 60px, rgba(34,197,94,0.02) 61px),
      repeating-linear-gradient(90deg, transparent, transparent 60px, rgba(34,197,94,0.02) 60px, rgba(34,197,94,0.02) 61px);
    pointer-events: none;
    z-index: 0;
  }

  .login-box {
    position: relative;
    width: min(420px, 94vw);
    background: var(--carbon);
    border: 1px solid var(--border);
    border-top: 4px solid var(--amber);
    padding: 3rem 2.5rem;
    animation: modalIn 0.35s ease;
    z-index: 1;
  }

  .login-logo {
    display: flex; align-items: center; gap: 14px;
    margin-bottom: 2.5rem;
  }
  .login-logo-mark {
    width: 48px; height: 48px;
    background: var(--amber);
    clip-path: polygon(0 0, 100% 0, 100% 70%, 70% 100%, 0 100%);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900; font-size: 22px; color: #fff;
  }
  .login-logo-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 28px; letter-spacing: 0.06em;
    color: var(--white);
    line-height: 1;
  }
  .login-logo-text span { color: var(--amber); }
  .login-logo-sub {
    font-size: 11px; color: var(--muted);
    letter-spacing: 0.12em; text-transform: uppercase;
    margin-top: 3px;
  }

  .login-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 1.5rem;
    display: flex; align-items: center; gap: 10px;
  }
  .login-title::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  .login-form-group {
    margin-bottom: 1rem;
  }
  .login-label {
    display: block;
    font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 6px;
  }
  .login-input {
    width: 100%;
    background: var(--plate); border: 1px solid var(--border);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 15px;
    padding: 12px 16px; outline: none;
    transition: border-color 0.15s;
  }
  .login-input:focus { border-color: var(--amber); }
  .login-input::placeholder { color: var(--muted); }

  .login-error {
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
    color: var(--red); font-size: 13px; padding: 10px 14px;
    margin-bottom: 1rem; display: none;
  }
  .login-error.show { display: block; }

  .login-btn {
    width: 100%;
    background: var(--amber); color: #fff;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 15px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
    padding: 14px; border: none; cursor: pointer;
    transition: background 0.15s;
    margin-top: 0.5rem;
  }
  .login-btn:hover { background: #16a34a; }
  .login-btn:active { transform: scale(0.99); }

  .login-hint {
    margin-top: 1.5rem; padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    font-size: 11px; color: var(--muted); text-align: center;
    letter-spacing: 0.05em;
  }

  /* ‚îÄ‚îÄ‚îÄ APP WRAPPER ‚îÄ‚îÄ‚îÄ */
  #app { display: none; }
  #app.visible { display: block; }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    background: var(--carbon);
    border-bottom: 3px solid var(--amber);
    padding: 0 2rem;
    display: flex;
    align-items: stretch;
    height: 64px;
    position: sticky; top: 0; z-index: 100;
  }

  .logo {
    display: flex; align-items: center; gap: 12px;
    margin-right: 3rem;
  }
  .logo-mark {
    width: 36px; height: 36px;
    background: var(--amber);
    clip-path: polygon(0 0, 100% 0, 100% 70%, 70% 100%, 0 100%);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900; font-size: 18px; color: #fff;
  }
  .logo-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 20px; letter-spacing: 0.08em;
    color: var(--white);
  }
  .logo-text span { color: var(--amber); }

  nav { display: flex; align-items: stretch; gap: 2px; }
  nav button {
    background: none; border: none; cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--mid);
    padding: 0 20px;
    border-bottom: 3px solid transparent;
    margin-bottom: -3px;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 8px;
  }
  nav button:hover { color: var(--light); }
  nav button.active { color: var(--amber); border-bottom-color: var(--amber); }
  nav button .icon { font-size: 16px; }

  .header-right {
    margin-left: auto;
    display: flex; align-items: center; gap: 16px;
  }
  .date-chip { font-size: 12px; color: var(--mid); letter-spacing: 0.05em; font-weight: 500; }

  .logout-btn {
    background: none; border: 1px solid var(--border);
    color: var(--muted); cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 6px 14px;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 6px;
  }
  .logout-btn:hover { border-color: var(--red); color: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
  main { padding: 2rem; max-width: 1400px; margin: 0 auto; }

  .page { display: none; animation: fadeIn 0.2s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
  @keyframes modalIn { from { opacity: 0; transform: scale(0.96) translateY(10px); } to { opacity: 1; transform: none; } }

  /* ‚îÄ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ‚îÄ */
  .page-header {
    display: flex; align-items: flex-end; justify-content: space-between;
    margin-bottom: 2rem; padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .page-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 42px; font-weight: 900; line-height: 1; letter-spacing: -0.01em;
    color: var(--white);
  }
  .page-title span { color: var(--amber); }
  .page-subtitle { font-size: 13px; color: var(--muted); margin-top: 4px; letter-spacing: 0.05em; text-transform: uppercase; }

  /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
  .btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 10px 20px; border: none; cursor: pointer;
    display: inline-flex; align-items: center; gap: 8px; transition: all 0.15s;
  }
  .btn-primary {
    background: var(--amber); color: #fff;
    clip-path: polygon(0 0, 100% 0, 100% 70%, 93% 100%, 0 100%);
  }
  .btn-primary:hover { background: #16a34a; }
  .btn-ghost { background: var(--plate); color: var(--light); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--amber); color: var(--amber); }
  .btn-danger { background: var(--red); color: white; }
  .btn-sm { font-size: 11px; padding: 6px 14px; }

  /* ‚îÄ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ‚îÄ */
  .stats-row {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px; margin-bottom: 2rem;
  }
  .stat-card {
    background: var(--carbon); border: 1px solid var(--border);
    border-top: 3px solid var(--amber);
    padding: 1.2rem 1.5rem; position: relative; overflow: hidden;
  }
  .stat-card::after {
    content: ''; position: absolute; bottom: -20px; right: -20px;
    width: 80px; height: 80px; background: var(--amber); opacity: 0.03; border-radius: 50%;
  }
  .stat-num {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 48px; font-weight: 900; line-height: 1; color: var(--white);
  }
  .stat-label { font-size: 11px; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-top: 4px; }

  /* ‚îÄ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ */
  .table-wrap { background: var(--carbon); border: 1px solid var(--border); overflow: hidden; }
  .table-toolbar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--steel);
  }
  .search-box {
    display: flex; align-items: center; gap: 10px;
    background: var(--plate); border: 1px solid var(--border); padding: 8px 14px;
  }
  .search-box input {
    background: none; border: none; outline: none;
    color: var(--text); font-size: 13px; width: 220px; font-family: 'Barlow', sans-serif;
  }
  .search-box input::placeholder { color: var(--muted); }

  table { width: 100%; border-collapse: collapse; }
  thead tr { background: var(--steel); }
  th {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border);
  }
  td { padding: 13px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 14px; color: var(--light); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(34,197,94,0.04); }

  .badge {
    display: inline-flex; align-items: center;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 3px 10px; border: 1px solid;
  }
  .badge-green { color: var(--green); border-color: rgba(34,197,94,0.3); background: rgba(34,197,94,0.07); }
  .badge-red { color: var(--red); border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.07); }
  .badge-amber { color: #86efac; border-color: rgba(134,239,172,0.3); background: rgba(134,239,172,0.07); }
  .badge-blue { color: var(--blue); border-color: rgba(59,130,246,0.3); background: rgba(59,130,246,0.07); }

  /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    z-index: 200; align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--steel); border: 1px solid var(--border); border-top: 3px solid var(--amber);
    width: min(600px, 95vw); max-height: 90vh; overflow-y: auto;
    animation: modalIn 0.2s ease;
  }
  .modal-header {
    padding: 1.5rem 2rem 1rem; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .modal-title { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 700; letter-spacing: 0.05em; }
  .modal-close { background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 4px 8px; transition: color 0.15s; }
  .modal-close:hover { color: var(--red); }
  .modal-body { padding: 1.5rem 2rem 2rem; }

  /* ‚îÄ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1 / -1; }
  label { font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
  input[type=text], input[type=date], input[type=tel], input[type=number], input[type=password], select, textarea {
    background: var(--plate); border: 1px solid var(--border);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 14px;
    padding: 10px 14px; outline: none; transition: border-color 0.15s; width: 100%;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--amber); }
  select option { background: var(--plate); }
  .form-actions {
    display: flex; gap: 12px; justify-content: flex-end;
    margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);
  }

  /* ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ */
  .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 1.5rem; }
  .dash-card { background: var(--carbon); border: 1px solid var(--border); padding: 1.5rem; }
  .dash-card-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 1rem;
    display: flex; align-items: center; gap: 8px;
  }
  .dash-card-title::before { content: ''; display: block; width: 16px; height: 2px; background: var(--amber); }

  .cantiere-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .cantiere-card {
    background: var(--carbon); border: 1px solid var(--border);
    padding: 1.5rem; cursor: pointer; transition: all 0.15s; position: relative; overflow: hidden;
  }
  .cantiere-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--amber); }
  .cantiere-card:hover { border-color: var(--amber); background: var(--steel); }
  .cantiere-name { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 700; color: var(--white); margin-bottom: 8px; }
  .cantiere-meta { font-size: 12px; color: var(--muted); }

  /* ‚îÄ‚îÄ‚îÄ PRESENZE NUOVE ‚îÄ‚îÄ‚îÄ */
  .presenza-toolbar {
    display: flex; align-items: center; gap: 16px;
    background: var(--carbon); border: 1px solid var(--border);
    padding: 1rem 1.5rem; margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  .presenza-toolbar input[type=date] { max-width: 180px; }

  .presenze-summary {
    display: flex; gap: 16px; margin-bottom: 1.5rem; flex-wrap: wrap;
  }
  .pres-sum-chip {
    display: flex; align-items: center; gap: 8px;
    background: var(--carbon); border: 1px solid var(--border);
    padding: 8px 16px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--muted);
  }
  .pres-sum-chip strong { font-size: 22px; color: var(--white); line-height: 1; }
  .pres-sum-chip.green strong { color: var(--green); }
  .pres-sum-chip.red strong { color: var(--red); }

  .presenze-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 12px;
  }

  /* Card operaio */
  .op-card {
    background: var(--carbon); border: 1px solid var(--border);
    position: relative; overflow: hidden;
    transition: border-color 0.15s, background 0.15s;
  }
  .op-card.presente {
    border-color: rgba(34,197,94,0.4);
    background: rgba(34,197,94,0.04);
  }
  .op-card.assente {
    border-color: rgba(239,68,68,0.3);
    background: rgba(239,68,68,0.03);
  }
  .op-card-accent {
    position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
    background: var(--border); transition: background 0.15s;
  }
  .op-card.presente .op-card-accent { background: var(--green); }
  .op-card.assente .op-card-accent { background: var(--red); }

  .op-card-top {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 16px 14px 20px;
  }
  .op-card-info { flex: 1; min-width: 0; }
  .op-card-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 17px; font-weight: 700; color: var(--white);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .op-card-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* Toggle presente/assente */
  .pres-toggle {
    display: flex; border: 1px solid var(--border); overflow: hidden; flex-shrink: 0;
  }
  .pres-toggle button {
    background: none; border: none; cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 8px 14px; color: var(--muted); transition: all 0.12s;
    white-space: nowrap;
  }
  .pres-toggle button:not(:last-child) { border-right: 1px solid var(--border); }
  .pres-toggle button.sel-presente { background: var(--green); color: #fff; border-color: var(--green); }
  .pres-toggle button.sel-assente { background: var(--red); color: #fff; border-color: var(--red); }
  .pres-toggle button:hover:not(.sel-presente):not(.sel-assente) { color: var(--light); background: var(--plate); }

  /* Body card (ore + cantiere) */
  .op-card-body {
    padding: 0 16px 14px 20px;
    display: flex; gap: 12px; align-items: flex-end;
    flex-wrap: wrap;
  }
  .op-card-body.hidden { display: none; }

  .ore-stepper {
    display: flex; flex-direction: column; gap: 4px;
  }
  .ore-stepper-label {
    font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted);
  }
  .ore-stepper-ctrl {
    display: flex; align-items: center;
    border: 1px solid var(--border); background: var(--plate);
  }
  .ore-stepper-ctrl button {
    background: none; border: none; cursor: pointer;
    width: 32px; height: 36px;
    font-size: 18px; font-weight: 700; color: var(--mid);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .ore-stepper-ctrl button:hover { color: var(--amber); background: rgba(34,197,94,0.08); }
  .ore-stepper-ctrl span {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px; font-weight: 700; color: var(--white);
    min-width: 48px; text-align: center;
    border-left: 1px solid var(--border); border-right: 1px solid var(--border);
    line-height: 36px;
  }

  .cantiere-select-wrap {
    display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 140px;
  }
  .cantiere-select-label {
    font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted);
  }
  .cantiere-select-wrap select {
    background: var(--plate); border: 1px solid var(--border);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 13px;
    padding: 8px 10px; outline: none; height: 36px;
  }
  .cantiere-select-wrap select:focus { border-color: var(--amber); }

  /* Motivo assenza */
  .op-card-assenza {
    padding: 0 16px 14px 20px;
    display: none;
  }
  .op-card-assenza.show { display: block; }
  .assenza-label {
    font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--red); opacity: 0.7; margin-bottom: 5px;
  }
  .assenza-select {
    width: 100%; background: var(--plate);
    border: 1px solid rgba(239,68,68,0.3);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 13px;
    padding: 8px 10px; outline: none; margin-bottom: 6px;
  }
  .assenza-select:focus { border-color: var(--red); }
  .assenza-note {
    width: 100%; background: var(--plate);
    border: 1px solid rgba(239,68,68,0.2);
    color: var(--text); font-family: 'Barlow', sans-serif; font-size: 13px;
    padding: 8px 10px; outline: none; resize: none;
    display: none;
  }
  .assenza-note.show { display: block; }
  .assenza-note:focus { border-color: var(--red); }

  .segn-card {
    background: var(--carbon); border: 1px solid var(--border); border-left: 4px solid var(--amber);
    padding: 1.2rem 1.5rem; margin-bottom: 12px;
    display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: start;
  }
  .segn-card.alta { border-left-color: var(--red); }
  .segn-card.bassa { border-left-color: var(--blue); }
  .segn-title { font-weight: 600; color: var(--white); margin-bottom: 4px; }
  .segn-body { font-size: 13px; color: var(--mid); }
  .segn-meta { font-size: 11px; color: var(--muted); margin-top: 8px; letter-spacing: 0.05em; }

  .empty { text-align: center; padding: 4rem 2rem; color: var(--muted); }
  .empty-icon { font-size: 48px; margin-bottom: 1rem; opacity: 0.4; }
  .empty-text { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; }

  @media (max-width: 768px) {
    main { padding: 0.75rem; }
    .dash-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .presenze-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .cantiere-cards { grid-template-columns: 1fr; }
    nav button span:not(.icon) { display: none; }
    .page-title { font-size: 28px; }
    .page-header { flex-wrap: wrap; gap: 12px; }
    .page-header .btn { width: 100%; justify-content: center; }
    .presenza-toolbar { flex-wrap: wrap; gap: 8px; }
    .presenza-toolbar > * { width: 100%; }
    .presenza-toolbar > div { margin-left: 0 !important; }
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { min-width: 600px; }
    .table-toolbar { flex-wrap: wrap; gap: 8px; }
    .table-toolbar > * { width: 100%; }
    .search-box input { width: 100%; }
    .form-actions { flex-direction: column-reverse; }
    .form-actions .btn { width: 100%; justify-content: center; }
  }

  @media (max-width: 640px) {
    header {
      flex-wrap: wrap;
      height: auto;
      padding: 0 1rem;
      gap: 0;
    }
    .logo { padding: 10px 0 0 0; }
    nav {
      order: 3;
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      gap: 0;
      border-top: 1px solid var(--border);
    }
    nav::-webkit-scrollbar { display: none; }
    nav button {
      padding: 0 14px;
      height: 44px;
      flex-shrink: 0;
    }
    .header-right {
      padding: 8px 0;
    }
    .date-chip { display: none; }
    main { padding: 0.5rem; }
    .modal { width: 98vw !important; max-width: 98vw !important; }
    .modal-body { padding: 1rem; }
    .modal-header { padding: 1rem; }
    .op-card-top { flex-wrap: wrap; }
    .pres-toggle { flex-wrap: nowrap; }
  }

  .toast {
    position: fixed; bottom: 2rem; right: 2rem;
    background: var(--amber); color: #fff;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 0.05em;
    padding: 12px 20px;
    clip-path: polygon(0 0, 100% 0, 100% 70%, 95% 100%, 0 100%);
    z-index: 999; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards;
  }
  @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: none; } }
  @keyframes toastOut { to { opacity: 0; transform: translateY(20px); } }

  .matr {
    display: inline-block; width: 28px; height: 28px;
    background: var(--plate); border: 1px solid var(--border);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px; font-weight: 700; color: var(--amber);
    text-align: center; line-height: 28px;
  }

  /* ‚îÄ‚îÄ‚îÄ GESTIONE UTENTI ‚îÄ‚îÄ‚îÄ */
  .users-section {
    background: var(--carbon); border: 1px solid var(--border);
    padding: 1.5rem; margin-bottom: 1.5rem;
  }
  .users-section-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 1rem;
    display: flex; align-items: center; gap: 8px;
  }
  .users-section-title::before { content: ''; display: block; width: 16px; height: 2px; background: var(--amber); }
  .user-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .user-row:last-child { border-bottom: none; }
  .user-info { display: flex; align-items: center; gap: 12px; }
  .user-avatar {
    width: 32px; height: 32px; background: var(--amber);
    clip-path: polygon(0 0, 100% 0, 100% 70%, 70% 100%, 0 100%);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 13px; color: #fff;
  }
  .user-avatar.admin-avatar { background: var(--blue); }

  /* Cambio password */
  #modal-cambio-password .modal { max-width: 400px; }

  /* ‚îÄ‚îÄ‚îÄ DIARIO ‚îÄ‚îÄ‚îÄ */
  .diario-card {
    background: var(--carbon); border: 1px solid var(--border);
    border-top: 3px solid var(--amber); padding: 16px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .diario-card-header { display:flex; justify-content:space-between; align-items:flex-start; }
  .diario-card-date { font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:700; color:var(--amber); letter-spacing:0.08em; text-transform:uppercase; }
  .diario-card-cantiere { font-size:12px; color:var(--muted); }
  .diario-card-autore { font-size:11px; color:var(--muted); margin-top:2px; }
  .diario-card-desc { font-size:14px; color:var(--light); line-height:1.5; }
  .diario-foto-grid { display:flex; flex-wrap:wrap; gap:6px; }
  .diario-foto-grid img { width:80px; height:80px; object-fit:cover; cursor:zoom-in; border:1px solid var(--border); transition:opacity 0.15s; }
  .diario-foto-grid img:hover { opacity:0.85; }
  .diario-delete-btn { background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px; padding:2px 6px; line-height:1; }
  .diario-delete-btn:hover { color:var(--red); }
  .preview-thumb { position:relative; display:inline-block; }
  .preview-thumb img { width:70px; height:70px; object-fit:cover; border:1px solid var(--border); }
  .preview-thumb .rm { position:absolute; top:-6px; right:-6px; background:var(--red); color:#fff; border:none; border-radius:50%; width:18px; height:18px; font-size:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; }
  .cd-entry { border-bottom:1px solid var(--border); padding:16px 0; }
  .cd-entry:last-child { border-bottom:none; }
  .cd-entry-header { display:flex; justify-content:space-between; margin-bottom:8px; align-items:flex-start; }
  .cd-entry-meta { font-size:12px; color:var(--muted); text-align:right; }
  .cd-entry-autore { font-family:'Barlow Condensed',sans-serif; font-size:14px; font-weight:700; color:var(--amber); }
  .cd-entry-desc { font-size:14px; color:var(--light); line-height:1.6; margin-bottom:10px; }

  /* ‚îÄ‚îÄ‚îÄ RENDICONTO OPERAIO / CANTIERE ‚îÄ‚îÄ‚îÄ */
  .rend-header {
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
    margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);
  }
  .rend-stat-row {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px; margin-bottom: 1.5rem;
  }
  .rend-stat {
    background: var(--plate); border: 1px solid var(--border);
    padding: 12px 14px; text-align: center;
  }
  .rend-stat-num {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 32px; font-weight: 900; color: var(--white); line-height: 1;
  }
  .rend-stat-num.green { color: var(--green); }
  .rend-stat-num.amber { color: var(--amber); }
  .rend-stat-num.red { color: var(--red); }
  .rend-stat-label {
    font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); margin-top: 4px;
  }
  .rend-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .rend-table th {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); padding: 8px 12px; text-align: left;
    border-bottom: 1px solid var(--border); background: var(--steel);
  }
  .rend-table td {
    padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.04);
    color: var(--light);
  }
  .rend-table tr:last-child td { border-bottom: none; }
  .rend-table tr:hover td { background: rgba(34,197,94,0.04); }
  .operaio-name-link {
    cursor: pointer; color: var(--white); transition: color 0.15s;
  }
  .operaio-name-link:hover { color: var(--amber); text-decoration: underline; }
  .cantiere-name-link {
    cursor: pointer; font-family: 'Barlow Condensed', sans-serif;
    font-size: 22px; font-weight: 700; color: var(--white);
    margin-bottom: 8px; transition: color 0.15s;
  }
  .cantiere-name-link:hover { color: var(--amber); }
</style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-bg"></div>
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-mark">KE</div>
      <div>
        <div class="login-logo-text">KE<span>¬∑</span>CANTIERE</div>
        <div class="login-logo-sub">Gestione Cantieri</div>
      </div>
    </div>

    <div class="login-title">Accesso</div>

    <div class="login-error" id="login-error">Credenziali non valide. Riprova.</div>

    <div class="login-form-group">
      <label class="login-label">Username</label>
      <input type="text" class="login-input" id="login-username" placeholder="Inserisci username" autocomplete="username">
    </div>
    <div class="login-form-group">
      <label class="login-label">Password</label>
      <input type="password" class="login-input" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>

    <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
      <input type="checkbox" id="remember-me" style="width:16px;height:16px;accent-color:var(--green);cursor:pointer">
      <label for="remember-me" style="font-size:13px;color:var(--muted);cursor:pointer;user-select:none">Ricorda credenziali</label>
    </div>

    <button class="login-btn" onclick="doLogin()">Entra ‚Üí</button>

    <div class="login-hint">
      Accesso riservato al personale autorizzato
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê -->
<div id="app">

<header>
  <div class="logo">
    <div class="logo-mark">KE</div>
    <div class="logo-text">KE<span>¬∑</span>CANTIERE</div>
  </div>
  <nav>
    <button class="active" data-page="dashboard" onclick="showPage('dashboard')">
      <span class="icon">‚äû</span> Dashboard
    </button>
    <button data-page="presenze" onclick="showPage('presenze')">
      <span class="icon">‚ó∑</span> Presenze
    </button>
    <button data-page="operai" onclick="showPage('operai')">
      <span class="icon">‚óâ</span> Operai
    </button>
    <button data-page="cantieri" onclick="showPage('cantieri')">
      <span class="icon">‚¨°</span> Cantieri
    </button>
    <button data-page="segnalazioni" onclick="showPage('segnalazioni')">
      <span class="icon">‚öë</span> Segnalazioni
    </button>
    <button data-page="diario" onclick="showPage('diario')" id="nav-diario" style="display:none">
      <span class="icon">üì∑</span> Diario
    </button>
    <button data-page="impostazioni" onclick="showPage('impostazioni')" id="nav-impostazioni" style="display:none">
      <span class="icon">‚öô</span> Impostazioni
    </button>
  </nav>
  <div class="header-right">
    <span class="date-chip" id="date-display"></span>
    <span id="header-user" style="font-size:12px;color:var(--muted);letter-spacing:0.05em"></span>
    <button class="logout-btn" onclick="doLogout()">‚èª Esci</button>
  </div>
</header>

<main>

  <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
  <div id="page-dashboard" class="page active">
    <div class="page-header">
      <div>
        <div class="page-title">Dashboard <span>.</span></div>
        <div class="page-subtitle">Riepilogo giornaliero</div>
      </div>
      <button class="btn btn-primary" onclick="showPage('presenze')">
        <span>+</span> Nuova Presenza
      </button>
    </div>
    <div class="stats-row" id="dash-stats"></div>
    <div class="dash-grid">
      <div class="dash-card">
        <div class="dash-card-title">Cantieri Attivi</div>
        <div id="dash-cantieri"></div>
      </div>
      <div class="dash-card">
        <div class="dash-card-title">Operai per Contratto</div>
        <div id="dash-contratti"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PRESENZE ‚ïê‚ïê‚ïê -->
  <div id="page-presenze" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Presenze <span>.</span></div>
        <div class="page-subtitle">Registrazione giornaliera</div>
      </div>
      <button class="btn btn-primary" onclick="salvaPresenze()">
        <span>‚úì</span> Salva Giornata
      </button>
    </div>

    <div class="presenza-toolbar">
      <label style="margin:0;white-space:nowrap;font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted)">Data</label>
      <input type="date" id="presenza-date" onchange="renderPresenze()" style="max-width:180px">
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <span style="font-size:12px;color:var(--muted)">Filtra:</span>
        <select id="presenza-filter" onchange="renderPresenze()" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:7px 12px;font-size:13px;outline:none">
          <option value="">Tutti gli operai</option>
          <option value="cassa_edile">Solo Cassa Edile</option>
          <option value="metalmeccanico">Solo Metalmeccanico</option>
        </select>
      </div>
    </div>

    <div class="presenze-summary" id="pres-summary"></div>
    <div class="presenze-grid" id="presenze-content"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê OPERAI ‚ïê‚ïê‚ïê -->
  <div id="page-operai" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Operai <span>.</span></div>
        <div class="page-subtitle" id="operai-count"></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <div style="display:flex;flex-direction:column;gap:3px">
          <label style="font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted)">Mese export</label>
          <input type="month" id="export-month" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:7px 12px;font-size:13px;outline:none">
        </div>
        <button class="btn" style="background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:var(--green);align-self:flex-end" onclick="esportaExcelOperai()">
          <span>‚¨á</span> Esporta Excel
        </button>
        <button class="btn btn-primary" onclick="openModalOperaio()">
          <span>+</span> Nuovo Operaio
        </button>
      </div>
    </div>
    <div class="table-wrap">
      <div class="table-toolbar">
        <div class="search-box">
          <span style="color:var(--muted)">‚åï</span>
          <input type="text" placeholder="Cerca operaio..." oninput="filterOperai(this.value)">
        </div>
        <div style="display:flex;gap:8px">
          <select id="filter-stato" onchange="renderOperai()" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-size:13px;outline:none">
            <option value="">Tutti gli stati</option>
            <option value="attivo">Attivi</option>
            <option value="inattivo">Inattivi</option>
          </select>
          <select id="filter-contratto" onchange="renderOperai()" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-size:13px;outline:none">
            <option value="">Tutti i contratti</option>
            <option value="cassa_edile">Cassa Edile</option>
            <option value="metalmeccanico">Metalmeccanico</option>
          </select>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Matr.</th><th>Nome</th><th>Contratto</th><th>Mansione</th><th>Telefono</th><th>Stato</th><th></th>
          </tr>
        </thead>
        <tbody id="operai-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê CANTIERI ‚ïê‚ïê‚ïê -->
  <div id="page-cantieri" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Cantieri <span>.</span></div>
        <div class="page-subtitle" id="cantieri-count"></div>
      </div>
      <button class="btn btn-primary" onclick="openModalCantiere()">
        <span>+</span> Nuovo Cantiere
      </button>
    </div>
    <div class="cantiere-cards" id="cantiere-cards"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê DIARIO CANTIERE (operai) ‚ïê‚ïê‚ïê -->
  <div id="page-diario" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Diario Cantiere <span>.</span></div>
        <div class="page-subtitle">Carica foto e descrivi il lavoro svolto</div>
      </div>
      <button class="btn btn-primary" onclick="openModalDiario()">
        <span>+</span> Nuovo Inserimento
      </button>
    </div>
    <div id="diario-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:8px"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SEGNALAZIONI ‚ïê‚ïê‚ïê -->
  <div id="page-segnalazioni" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Segnalazioni <span>.</span></div>
        <div class="page-subtitle">Problemi e note dal campo</div>
      </div>
      <button class="btn btn-primary" onclick="openModalSegnalazione()">
        <span>+</span> Nuova Segnalazione
      </button>
    </div>
    <div id="segnalazioni-list"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê IMPOSTAZIONI ‚ïê‚ïê‚ïê -->
  <div id="page-impostazioni" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Impostazioni <span>.</span></div>
        <div class="page-subtitle">Gestione utenti e accessi</div>
      </div>
    </div>

    <!-- Utenti esistenti -->
    <div class="users-section">
      <div class="users-section-title">Utenti del Sistema</div>
      <div id="users-list"></div>
    </div>

    <!-- Aggiungi utente -->
    <div class="users-section">
      <div class="users-section-title">Aggiungi Utente</div>
      <div class="form-grid" style="max-width:600px">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="new-username" placeholder="Nome utente">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="new-password" placeholder="Password">
        </div>
        <div class="form-group">
          <label>Ruolo</label>
          <select id="new-role">
            <option value="user">Operatore</option>
            <option value="admin">Amministratore</option>
          </select>
        </div>
        <div class="form-group" style="display:flex;align-items:flex-end">
          <button class="btn btn-primary" onclick="aggiungiUtente()" style="width:100%">
            <span>+</span> Aggiungi
          </button>
        </div>
      </div>
    </div>
  </div>

</main>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL OPERAIO ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-operaio">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-operaio-title">Nuovo Operaio</div>
      <button class="modal-close" onclick="closeModal('modal-operaio')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full">
          <label>Nome Completo</label>
          <input type="text" id="op-nome" placeholder="Cognome Nome">
        </div>
        <div class="form-group">
          <label>Matricola</label>
          <input type="text" id="op-matr" placeholder="Es. 42">
        </div>
        <div class="form-group">
          <label>Contratto</label>
          <select id="op-contratto">
            <option value="cassa_edile">Cassa Edile</option>
            <option value="metalmeccanico">Metalmeccanico</option>
          </select>
        </div>
        <div class="form-group">
          <label>Mansione</label>
          <input type="text" id="op-mansione" placeholder="Es. Muratore">
        </div>
        <div class="form-group">
          <label>Telefono</label>
          <input type="tel" id="op-tel" placeholder="+39 ...">
        </div>
        <div class="form-group">
          <label>Cantiere Default</label>
          <select id="op-cantiere-default">
            <option value="">‚Äî Nessuno ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label>Stato</label>
          <select id="op-stato">
            <option value="attivo">Attivo</option>
            <option value="inattivo">Inattivo</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeModal('modal-operaio')">Annulla</button>
        <button class="btn btn-primary" onclick="salvaOperaio()">Salva</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL CANTIERE ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-cantiere">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-cantiere-title">Nuovo Cantiere</div>
      <button class="modal-close" onclick="closeModal('modal-cantiere')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full">
          <label>Nome Cantiere</label>
          <input type="text" id="cant-nome" placeholder="Es. Via Roma 12 - Milano">
        </div>
        <div class="form-group full">
          <label>Indirizzo</label>
          <input type="text" id="cant-indirizzo" placeholder="Indirizzo completo">
        </div>
        <div class="form-group">
          <label>Stato</label>
          <select id="cant-stato">
            <option value="attivo">Attivo</option>
            <option value="completato">Completato</option>
            <option value="sospeso">Sospeso</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Note</label>
          <textarea id="cant-note" rows="3" placeholder="Note sul cantiere..." style="resize:vertical"></textarea>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeModal('modal-cantiere')">Annulla</button>
        <button class="btn btn-primary" onclick="salvaCantiere()">Salva</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL DIARIO CANTIERE ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-diario">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div class="modal-title">Nuovo Inserimento Diario</div>
      <button class="modal-close" onclick="closeModal('modal-diario')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Data</label>
          <input type="date" id="diario-data">
        </div>
        <div class="form-group">
          <label>Cantiere</label>
          <select id="diario-cantiere"></select>
        </div>
        <div class="form-group full">
          <label>Descrizione lavori</label>
          <textarea id="diario-desc" rows="4" placeholder="Descrivi cosa √® stato fatto oggi..." style="resize:vertical"></textarea>
        </div>
        <div class="form-group full">
          <label>Foto (max 5)</label>
          <div id="diario-foto-preview" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px"></div>
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer;background:var(--plate);border:1px dashed var(--border);padding:12px;color:var(--muted)">
            <span style="font-size:20px">üì∑</span>
            <span>Clicca per aggiungere foto</span>
            <input type="file" id="diario-foto-input" accept="image/*" multiple style="display:none" onchange="previewFotoDiario(this)">
          </label>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeModal('modal-diario')">Annulla</button>
        <button class="btn btn-primary" onclick="salvaDiario()">Salva</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL DETTAGLIO CANTIERE (admin) ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-cantiere-detail">
  <div class="modal" style="max-width:780px;max-height:88vh;overflow-y:auto">
    <div class="modal-header">
      <div class="modal-title" id="cantiere-detail-title">Diario Cantiere</div>
      <button class="modal-close" onclick="closeModal('modal-cantiere-detail')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="cantiere-detail-content"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL RENDICONTO OPERAIO ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-rendiconto-operaio">
  <div class="modal" style="max-width:820px;max-height:90vh;overflow-y:auto">
    <div class="modal-header">
      <div class="modal-title" id="rend-op-title">Resoconto Operaio</div>
      <button class="modal-close" onclick="closeModal('modal-rendiconto-operaio')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="rend-header">
        <div>
          <label style="font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px">Mese</label>
          <input type="month" id="rend-op-month" onchange="aggiornaRendicontoOperaio()" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-size:13px;outline:none">
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:flex-end">
          <button class="btn btn-ghost btn-sm" onclick="rendMesePrec()">‚Üê Prec.</button>
          <button class="btn btn-ghost btn-sm" onclick="rendMeseSucc()">Succ. ‚Üí</button>
        </div>
      </div>
      <div class="rend-stat-row" id="rend-op-stats"></div>
      <div style="overflow-x:auto">
        <table class="rend-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Stato</th>
              <th>Ore Ord.</th>
              <th>Straord.</th>
              <th>Ore Tot.</th>
              <th>Cantiere</th>
            </tr>
          </thead>
          <tbody id="rend-op-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL RENDICONTO CANTIERE ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-rendiconto-cantiere">
  <div class="modal" style="max-width:820px;max-height:90vh;overflow-y:auto">
    <div class="modal-header">
      <div class="modal-title" id="rend-cant-title">Resoconto Cantiere</div>
      <button class="modal-close" onclick="closeModal('modal-rendiconto-cantiere')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="rend-header">
        <div>
          <label style="font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px">Mese</label>
          <input type="month" id="rend-cant-month" onchange="aggiornaRendicontoCantiere()" style="background:var(--plate);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-size:13px;outline:none">
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:flex-end">
          <button class="btn btn-ghost btn-sm" onclick="rendCantMesePrec()">‚Üê Prec.</button>
          <button class="btn btn-ghost btn-sm" onclick="rendCantMeseSucc()">Succ. ‚Üí</button>
        </div>
      </div>
      <div class="rend-stat-row" id="rend-cant-stats"></div>
      <div style="overflow-x:auto">
        <table class="rend-table">
          <thead>
            <tr>
              <th>Operaio</th>
              <th>Contratto</th>
              <th>GG Pres.</th>
              <th>GG Ass.</th>
              <th>Ore Ord.</th>
              <th>Straord.</th>
              <th>Ore Tot.</th>
            </tr>
          </thead>
          <tbody id="rend-cant-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL FOTO FULLSCREEN ‚ïê‚ïê‚ïê -->
<div id="foto-lightbox" onclick="this.style.display='none'" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:9000;cursor:zoom-out;align-items:center;justify-content:center">
  <img id="foto-lightbox-img" style="max-width:90vw;max-height:90vh;object-fit:contain">
</div>

<!-- ‚ïê‚ïê‚ïê MODAL SEGNALAZIONE ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-segnalazione">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Nuova Segnalazione</div>
      <button class="modal-close" onclick="closeModal('modal-segnalazione')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full">
          <label>Titolo</label>
          <input type="text" id="segn-titolo" placeholder="Descrizione breve">
        </div>
        <div class="form-group">
          <label>Cantiere</label>
          <select id="segn-cantiere"></select>
        </div>
        <div class="form-group">
          <label>Priorit√†</label>
          <select id="segn-priorita">
            <option value="media">Media</option>
            <option value="alta">Alta</option>
            <option value="bassa">Bassa</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Descrizione</label>
          <textarea id="segn-desc" rows="4" placeholder="Dettagli della segnalazione..." style="resize:vertical"></textarea>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeModal('modal-segnalazione')">Annulla</button>
        <button class="btn btn-primary" onclick="salvaSegnalazione()">Segnala</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL CAMBIO PASSWORD ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-cambio-password">
  <div class="modal" style="max-width:400px">
    <div class="modal-header">
      <div class="modal-title">Cambia Password</div>
      <button class="modal-close" onclick="closeModal('modal-cambio-password')">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="cp-username">
      <div class="form-grid" style="grid-template-columns:1fr">
        <div class="form-group">
          <label>Nuova Password</label>
          <input type="password" id="cp-password" placeholder="Nuova password">
        </div>
        <div class="form-group">
          <label>Conferma Password</label>
          <input type="password" id="cp-confirm" placeholder="Ripeti password">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeModal('modal-cambio-password')">Annulla</button>
        <button class="btn btn-primary" onclick="salvaCambioPassword()">Salva</button>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Hash semplice (XOR + base64) per offuscare le password nel localStorage
// Non √® crittografia reale ma evita che le password siano in chiaro
function hashPwd(pwd) {
  let r = '';
  const salt = 'ke_cantiere_2024';
  for (let i = 0; i < pwd.length; i++) {
    r += String.fromCharCode(pwd.charCodeAt(i) ^ salt.charCodeAt(i % salt.length));
  }
  return btoa(r);
}

function getUsers() {
  const def = [
    { username: 'admin', password: hashPwd('admin123'), role: 'admin' },
    { username: 'cantiere', password: hashPwd('cantiere'), role: 'user' }
  ];
  try {
    const stored = localStorage.getItem('ke_users');
    return stored ? JSON.parse(stored) : def;
  } catch { return def; }
}

function saveUsers(users) {
  localStorage.setItem('ke_users', JSON.stringify(users));
  // Sync utenti col server (condivisi tra dispositivi)
  fetch('/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(users)
  }).catch(() => {});
}

// Carica utenti dal server all'avvio
async function syncUsersFromServer() {
  try {
    const r = await fetch('/api/users');
    if (!r.ok) return;
    const users = await r.json();
    if (users && users.length > 0) {
      localStorage.setItem('ke_users', JSON.stringify(users));
    }
  } catch(e) {}
}

let currentUser = null;

async function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const remember = document.getElementById('remember-me').checked;
  const err = document.getElementById('login-error');

  const users = getUsers();
  const user = users.find(u => u.username === username && u.password === hashPwd(password));

  if (!user) {
    err.classList.add('show');
    document.getElementById('login-password').value = '';
    document.getElementById('login-password').focus();
    return;
  }

  err.classList.remove('show');
  currentUser = user;
  sessionStorage.setItem('ke_session', JSON.stringify({ username: user.username, role: user.role }));

  // Ricorda credenziali: salva username in localStorage (la password MAI in chiaro)
  if (remember) {
    localStorage.setItem('ke_remember_user', username);
  } else {
    localStorage.removeItem('ke_remember_user');
  }

  await loginSuccess(user);
}

async function loginSuccess(user) {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app').classList.add('visible');
  document.getElementById('header-user').textContent = user.username.toUpperCase();

  // Carica utenti e dati freschi dal server
  await syncUsersFromServer();
  await loadDBFromServer();

  applyRoleUI();
  renderDashboard();
  initPresenze();
  initExportMonth();
}

function doLogout() {
  currentUser = null;
  sessionStorage.removeItem('ke_session');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('login-username').focus();
  // Ripristina username salvato se presente
  checkRemember();
}

// Enter key nel login
document.addEventListener('keydown', function(e) {
  const ls = document.getElementById('login-screen');
  if (!ls.classList.contains('hidden') && e.key === 'Enter') doLogin();
});

// Controlla sessione esistente
// ‚îÄ‚îÄ Ricorda credenziali ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkRemember() {
  const saved = localStorage.getItem('ke_remember_user');
  if (saved) {
    document.getElementById('login-username').value = saved;
    document.getElementById('remember-me').checked = true;
    document.getElementById('login-password').focus();
  }
}

(async function() {
  // Ripristina sessione attiva (stessa tab/finestra)
  const session = sessionStorage.getItem('ke_session');
  if (session) {
    try {
      const s = JSON.parse(session);
      const users = getUsers();
      const user = users.find(u => u.username === s.username && u.role === s.role);
      if (user) {
        currentUser = user;
        await loginSuccess(user);
      }
    } catch(e) {}
  }
  // Ricorda credenziali: precompila username
  checkRemember();
})();

// ‚îÄ‚îÄ Gestione utenti (solo admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderUsersList() {
  const users = getUsers();
  document.getElementById('users-list').innerHTML = users.map(u => `
    <div class="user-row">
      <div class="user-info">
        <div class="user-avatar ${u.role === 'admin' ? 'admin-avatar' : ''}">${u.username[0].toUpperCase()}</div>
        <div>
          <div style="font-weight:500;color:var(--white)">${u.username}</div>
          <div style="font-size:11px;color:var(--muted)">${u.role === 'admin' ? 'Amministratore' : 'Operatore'}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-ghost btn-sm" onclick="openCambioPassword('${u.username}')">Cambia pwd</button>
        ${u.username !== currentUser?.username ? `<button class="btn btn-sm" style="background:rgba(239,68,68,0.15);color:var(--red);border:1px solid rgba(239,68,68,0.3)" onclick="eliminaUtente('${u.username}')">Elimina</button>` : '<span class="badge badge-green">Tu</span>'}
      </div>
    </div>
  `).join('');
}

function aggiungiUtente() {
  const username = document.getElementById('new-username').value.trim();
  const password = document.getElementById('new-password').value;
  const role = document.getElementById('new-role').value;

  if (!username || !password) { toast('Compila tutti i campi'); return; }

  const users = getUsers();
  if (users.find(u => u.username === username)) { toast('Username gi√† esistente'); return; }

  users.push({ username, password: hashPwd(password), role });
  saveUsers(users);

  document.getElementById('new-username').value = '';
  document.getElementById('new-password').value = '';
  renderUsersList();
  toast('Utente aggiunto ‚úì');
}

function eliminaUtente(username) {
  if (!confirm(`Eliminare l'utente "${username}"?`)) return;
  const users = getUsers().filter(u => u.username !== username);
  saveUsers(users);
  renderUsersList();
  toast('Utente eliminato');
}

function openCambioPassword(username) {
  document.getElementById('cp-username').value = username;
  document.getElementById('cp-password').value = '';
  document.getElementById('cp-confirm').value = '';
  document.getElementById('modal-cambio-password').classList.add('open');
}

function salvaCambioPassword() {
  const username = document.getElementById('cp-username').value;
  const pwd = document.getElementById('cp-password').value;
  const confirm = document.getElementById('cp-confirm').value;

  if (!pwd) { toast('Inserisci la password'); return; }
  if (pwd !== confirm) { toast('Le password non coincidono'); return; }

  const users = getUsers();
  const idx = users.findIndex(u => u.username === username);
  if (idx !== -1) {
    users[idx].password = hashPwd(pwd);
    saveUsers(users);
    closeModal('modal-cambio-password');
    toast('Password aggiornata ‚úì');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RAW_DATA = {"operai":[{"name":"MOHAMED KHALIL ABOUELAILA ABDELRAHMAN","contratto":"cassa_edile","matr":"4","id":"w29b51fad","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"MOBARAK ABOUELELA","contratto":"cassa_edile","matr":"3","id":"w8c7334f1","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"ELSAYED OMAR SAID AHMED MOHAMED","contratto":"cassa_edile","matr":"27","id":"wa4d5159f","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"CASSINELLI GIANMARIO","contratto":"cassa_edile","matr":"13","id":"w8cdf3a4c","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"FATHY ESMAEIL EL FAYOUMY HAITHM","contratto":"cassa_edile","matr":"","id":"w36253b39","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"MANNINO DANIELA MARTINA","contratto":"metalmeccanico","matr":"","id":"wacd0d187","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"CAPELLETTI MASSIMO","contratto":"metalmeccanico","matr":"","id":"w43517b7d","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"DI DONATO MARINA ALEJANDRA","contratto":"metalmeccanico","matr":"","id":"w6f5b326a","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"CAPELLETTI PATRIZIO","contratto":"metalmeccanico","matr":"","id":"w24702665","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"STURNIOLO CARMELO","contratto":"metalmeccanico","matr":"","id":"wa4317b06","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"IANNELLO PINO","contratto":"metalmeccanico","matr":"","id":"w83f28c2e","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"IANNELLO MIRKO","contratto":"metalmeccanico","matr":"","id":"w42c5bcb8","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"OSMAN OSMAN IBRAHIM","contratto":"cassa_edile","matr":"","id":"w37b5a7e3","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"ABDELHAK ZAHRAN","contratto":"cassa_edile","matr":"","id":"w1e79b1ec","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"MILED HNEYDI","contratto":"cassa_edile","matr":"","id":"w80b4eae5","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"BOUACIDA NASSIM","contratto":"cassa_edile","matr":"","id":"wbb53f793","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"CAPELLETTI FABIO","contratto":"metalmeccanico","matr":"","id":"wcf82f0e4","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"ELMOLLA MOSTAFA FATHI","contratto":"cassa_edile","matr":"","id":"w4a0b2c56","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"},{"name":"HMAIDI SEIFEDDINE","contratto":"cassa_edile","matr":"","id":"w1cfff31c","mansione":"","tel":"","cantiereDefault":"","stato":"attivo"}],"cantieri":[{"id":"c001","name":"Rozzano","indirizzo":"","stato":"attivo","note":""},{"id":"c002","name":"Sesto San Giovanni","indirizzo":"","stato":"attivo","note":""},{"id":"c003","name":"Via Tofano","indirizzo":"","stato":"attivo","note":""}],"giornate":[],"registrazioni":[],"segnalazioni":[]};

let db = JSON.parse(JSON.stringify(RAW_DATA)); // sar√† sovrascritto dal server
if (!db.diari) db.diari = [];

// ‚îÄ‚îÄ DB: carica dal server, fallback localStorage ‚îÄ‚îÄ
async function loadDBFromServer() {
  try {
    const r = await fetch('/api/data');
    if (!r.ok) throw new Error('Server error');
    const data = await r.json();
    // Se il server ha dati reali usali, altrimenti usa localStorage
    if (data && (data.operai?.length > 0 || data.giornate?.length > 0)) {
      db = data;
      if (!db.diari) db.diari = [];
      localStorage.setItem('ke_cantiere_db', JSON.stringify(db)); // sync locale
    } else {
      // Primo avvio: prendo da localStorage e carico sul server
      const local = localStorage.getItem('ke_cantiere_db');
      if (local) {
        db = JSON.parse(local);
        if (!db.diari) db.diari = [];
        await saveDB(); // mando al server
      }
    }
  } catch(e) {
    // Offline o errore: usa localStorage
    const local = localStorage.getItem('ke_cantiere_db');
    if (local) { db = JSON.parse(local); if (!db.diari) db.diari = []; }
    console.warn('Modalit√† offline - dati da localStorage');
  }
}

function saveDB() {
  localStorage.setItem('ke_cantiere_db', JSON.stringify(db));
  // Sync con server (non-blocking)
  fetch('/api/data', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(db)
  }).catch(() => console.warn('Salvataggio server fallito, dati in localStorage'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSearch = '';
let editingId = null;

// Pagine riservate agli admin
const ADMIN_PAGES = ['presenze', 'operai', 'cantieri', 'impostazioni'];
const USER_PAGES = ['dashboard', 'segnalazioni', 'diario'];

function showPage(name) {
  if (ADMIN_PAGES.includes(name) && currentUser?.role !== 'admin') {
    toast('‚õî Accesso non consentito');
    return;
  }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelector(`[data-page="${name}"]`).classList.add('active');
  
  if (name === 'dashboard') renderDashboard();
  if (name === 'operai') renderOperai();
  if (name === 'cantieri') renderCantieri();
  if (name === 'presenze') renderPresenze();
  if (name === 'segnalazioni') renderSegnalazioni();
  if (name === 'impostazioni') renderUsersList();
  if (name === 'diario') renderDiario();
}

function applyRoleUI() {
  const isAdmin = currentUser?.role === 'admin';
  ['presenze', 'operai', 'cantieri'].forEach(page => {
    const btn = document.querySelector(`[data-page="${page}"]`);
    if (btn) btn.style.display = isAdmin ? '' : 'none';
  });
  document.getElementById('nav-impostazioni').style.display = isAdmin ? '' : 'none';
  document.getElementById('nav-diario').style.display = isAdmin ? 'none' : '';
  const dashBtn = document.querySelector("[onclick=\"showPage('presenze')\"]");
  if (dashBtn) dashBtn.style.display = isAdmin ? '' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function todayStr() { return new Date().toISOString().split('T')[0]; }
function formatDate(s) {
  if (!s) return '';
  const d = new Date(s + 'T00:00:00');
  return d.toLocaleDateString('it-IT', { weekday:'short', day:'numeric', month:'short', year:'numeric' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const attivi = db.operai.filter(o => o.stato === 'attivo').length;
  const cantieri = db.cantieri.filter(c => c.stato === 'attivo').length;
  const segnalazioni = db.segnalazioni.filter(s => s.aperta !== false).length;

  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-card"><div class="stat-num">${attivi}</div><div class="stat-label">Operai Attivi</div></div>
    <div class="stat-card"><div class="stat-num">${cantieri}</div><div class="stat-label">Cantieri Attivi</div></div>
    <div class="stat-card"><div class="stat-num">${db.giornate.length}</div><div class="stat-label">Presenze Totali</div></div>
    <div class="stat-card"><div class="stat-num">${segnalazioni}</div><div class="stat-label">Segnalazioni Aperte</div></div>
  `;

  document.getElementById('dash-cantieri').innerHTML = db.cantieri.map(c => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-weight:500;color:var(--white)">${c.name}</div>
        <div style="font-size:11px;color:var(--muted)">${c.indirizzo || 'Indirizzo non specificato'}</div>
      </div>
      <span class="badge badge-${c.stato === 'attivo' ? 'green' : c.stato === 'sospeso' ? 'amber' : 'blue'}">${c.stato}</span>
    </div>
  `).join('') || '<div class="empty"><div class="empty-text">Nessun cantiere</div></div>';

  const conteggi = {};
  db.operai.filter(o => o.stato === 'attivo').forEach(o => {
    const k = o.contratto === 'cassa_edile' ? 'Cassa Edile' : 'Metalmeccanico';
    conteggi[k] = (conteggi[k] || 0) + 1;
  });
  const tot = db.operai.filter(o => o.stato === 'attivo').length;
  document.getElementById('dash-contratti').innerHTML = Object.entries(conteggi).map(([k, v]) => `
    <div style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-size:13px;color:var(--light)">${k}</span>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--white)">${v}</span>
      </div>
      <div style="height:4px;background:var(--plate)">
        <div style="height:100%;width:${Math.round(v/tot*100)}%;background:var(--amber)"></div>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OPERAI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function filterOperai(v) { currentSearch = v.toLowerCase(); renderOperai(); }

function renderOperai() {
  const stato = document.getElementById('filter-stato').value;
  const contratto = document.getElementById('filter-contratto').value;
  let lista = db.operai.filter(o => {
    if (stato && o.stato !== stato) return false;
    if (contratto && o.contratto !== contratto) return false;
    if (currentSearch && !o.name.toLowerCase().includes(currentSearch)) return false;
    return true;
  });
  document.getElementById('operai-count').textContent = `${lista.length} operai`;
  if (!lista.length) {
    document.getElementById('operai-tbody').innerHTML = `<tr><td colspan="7"><div class="empty"><div class="empty-icon">‚óâ</div><div class="empty-text">Nessun operaio trovato</div></div></td></tr>`;
    return;
  }
  document.getElementById('operai-tbody').innerHTML = lista.map(o => `
    <tr>
      <td><div class="matr">${o.matr || '‚Äî'}</div></td>
      <td><span class="operaio-name-link" onclick="apriRendicontoOperaio('${o.id}')">${titleCase(o.name)}</span></td>
      <td><span class="badge badge-${o.contratto === 'cassa_edile' ? 'amber' : 'blue'}">${o.contratto === 'cassa_edile' ? 'Cassa Edile' : 'Metalmeccanico'}</span></td>
      <td style="color:var(--muted)">${o.mansione || '‚Äî'}</td>
      <td style="color:var(--muted)">${o.tel || '‚Äî'}</td>
      <td><span class="badge badge-${o.stato === 'attivo' ? 'green' : 'red'}">${o.stato}</span></td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="apriRendicontoOperaio('${o.id}')">üìã</button>
        <button class="btn btn-ghost btn-sm" onclick="openModalOperaio('${o.id}')">Modifica</button>
        <button class="btn btn-sm" style="background:rgba(239,68,68,0.15);color:var(--red);border:1px solid rgba(239,68,68,0.3)" onclick="eliminaOperaio('${o.id}','${o.name}')">Elimina</button>
      </td>
    </tr>
  `).join('');
}

function eliminaOperaio(id, nome) {
  if (!confirm('Eliminare definitivamente ' + titleCase(nome) + '?\nATTENZIONE: verranno cancellate anche tutte le sue giornate presenze.')) return;
  db.operai = db.operai.filter(o => o.id !== id);
  db.giornate = db.giornate.filter(g => g.operaio !== id);
  saveDB();
  renderOperai();
  toast('Operaio eliminato');
}

function openModalOperaio(id = null) {
  editingId = id;
  const sel = document.getElementById('op-cantiere-default');
  sel.innerHTML = '<option value="">‚Äî Nessuno ‚Äî</option>' + db.cantieri.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  if (id) {
    const o = db.operai.find(x => x.id === id);
    document.getElementById('modal-operaio-title').textContent = 'Modifica Operaio';
    document.getElementById('op-nome').value = o.name;
    document.getElementById('op-matr').value = o.matr;
    document.getElementById('op-contratto').value = o.contratto;
    document.getElementById('op-mansione').value = o.mansione;
    document.getElementById('op-tel').value = o.tel;
    document.getElementById('op-cantiere-default').value = o.cantiereDefault;
    document.getElementById('op-stato').value = o.stato;
  } else {
    document.getElementById('modal-operaio-title').textContent = 'Nuovo Operaio';
    ['op-nome','op-matr','op-mansione','op-tel'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('op-contratto').value = 'cassa_edile';
    document.getElementById('op-cantiere-default').value = '';
    document.getElementById('op-stato').value = 'attivo';
  }
  document.getElementById('modal-operaio').classList.add('open');
}

function salvaOperaio() {
  const nome = document.getElementById('op-nome').value.trim();
  if (!nome) { alert('Inserisci il nome'); return; }
  const data = {
    name: nome.toUpperCase(), matr: document.getElementById('op-matr').value.trim(),
    contratto: document.getElementById('op-contratto').value,
    mansione: document.getElementById('op-mansione').value.trim(),
    tel: document.getElementById('op-tel').value.trim(),
    cantiereDefault: document.getElementById('op-cantiere-default').value,
    stato: document.getElementById('op-stato').value,
  };
  if (editingId) {
    const idx = db.operai.findIndex(o => o.id === editingId);
    db.operai[idx] = { ...db.operai[idx], ...data };
  } else {
    db.operai.push({ ...data, id: 'w' + Math.random().toString(16).slice(2,10) });
  }
  saveDB(); closeModal('modal-operaio'); renderOperai();
  toast(editingId ? 'Operaio aggiornato' : 'Operaio aggiunto');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANTIERI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCantieri() {
  document.getElementById('cantieri-count').textContent = `${db.cantieri.length} cantieri`;
  document.getElementById('cantiere-cards').innerHTML = db.cantieri.map(c => {
    const nDiari = (db.diari || []).filter(d => d.cantiere === c.id).length;
    return `
    <div class="cantiere-card" style="cursor:default">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
        <div class="cantiere-name-link" onclick="apriRendicontoCantiere('${c.id}')">${c.name}</div>
        <span class="badge badge-${c.stato === 'attivo' ? 'green' : c.stato === 'sospeso' ? 'amber' : 'blue'}">${c.stato}</span>
      </div>
      <div class="cantiere-meta">${c.indirizzo || 'Indirizzo da definire'}</div>
      ${c.note ? `<div class="cantiere-meta" style="margin-top:8px">${c.note}</div>` : ''}
      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <button class="btn btn-ghost btn-sm" onclick="openModalCantiere('${c.id}')">‚úè Modifica</button>
        <button class="btn btn-sm" style="background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:var(--green)" onclick="openDettaglioCantiere('${c.id}')">
          üì∑ Diario ${nDiari > 0 ? `<span style="background:var(--amber);color:#000;border-radius:10px;padding:1px 6px;font-size:10px;margin-left:4px">${nDiari}</span>` : ''}
        </button>
        <button class="btn btn-sm" style="background:rgba(59,130,246,0.12);border:1px solid rgba(59,130,246,0.3);color:var(--blue)" onclick="apriRendicontoCantiere('${c.id}')">
          üìã Resoconto
        </button>
      </div>
    </div>
  `}).join('');
}

function openModalCantiere(id = null) {
  editingId = id;
  if (id) {
    const c = db.cantieri.find(x => x.id === id);
    document.getElementById('modal-cantiere-title').textContent = 'Modifica Cantiere';
    document.getElementById('cant-nome').value = c.name;
    document.getElementById('cant-indirizzo').value = c.indirizzo;
    document.getElementById('cant-stato').value = c.stato;
    document.getElementById('cant-note').value = c.note;
  } else {
    document.getElementById('modal-cantiere-title').textContent = 'Nuovo Cantiere';
    ['cant-nome','cant-indirizzo','cant-note'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('cant-stato').value = 'attivo';
  }
  document.getElementById('modal-cantiere').classList.add('open');
}

function salvaCantiere() {
  const nome = document.getElementById('cant-nome').value.trim();
  if (!nome) { alert('Inserisci il nome'); return; }
  const data = {
    name: nome, indirizzo: document.getElementById('cant-indirizzo').value.trim(),
    stato: document.getElementById('cant-stato').value,
    note: document.getElementById('cant-note').value.trim(),
  };
  if (editingId) {
    const idx = db.cantieri.findIndex(c => c.id === editingId);
    db.cantieri[idx] = { ...db.cantieri[idx], ...data };
  } else {
    db.cantieri.push({ ...data, id: 'c' + Date.now() });
  }
  saveDB(); closeModal('modal-cantiere'); renderCantieri();
  toast(editingId ? 'Cantiere aggiornato' : 'Cantiere aggiunto');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRESENZE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Stato in memoria per la sessione di editing
let presenzeState = {}; // { [operaioId]: { stato: 'presente'|'assente'|null, ore: 8, straord: 0, cantiere: '', motivoTipo: '', motivoNote: '' } }

const MOTIVI_ASSENZA = [
  { value: 'malattia', label: 'Malattia' },
  { value: 'ferie', label: 'Ferie' },
  { value: 'permesso', label: 'Permesso' },
  { value: 'infortunio', label: 'Infortunio' },
  { value: 'aspettativa', label: 'Aspettativa' },
  { value: 'altro', label: 'Altro (specifica...)' },
];


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ESPORTA EXCEL OPERAI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initExportMonth() {
  const now = new Date();
  const m = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  document.getElementById('export-month').value = m;
}

function esportaExcelOperai() {
  const monthVal = document.getElementById('export-month').value;
  if (!monthVal) { toast('Seleziona un mese'); return; }

  const [year, month] = monthVal.split('-').map(Number);
  const monthLabel = new Date(year, month - 1, 1).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
  const daysInMonth = new Date(year, month, 0).getDate();
  const allDays = Array.from({ length: daysInMonth }, (_, i) => {
    return `${year}-${String(month).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`;
  });
  const getDow = (ds) => new Date(ds + 'T00:00:00').getDay();
  const DOW = ['D','L','M','Me','G','V','S'];

  const operaiAttivi = db.operai.filter(o => o.stato === 'attivo');
  const edili = operaiAttivi.filter(o => o.contratto === 'cassa_edile');
  const metalmeccanici = operaiAttivi.filter(o => o.contratto === 'metalmeccanico');

  // ‚îÄ‚îÄ Helper: crea cella con stile ‚îÄ‚îÄ
  function mc(v, fillRgb, colorRgb, bold, alignH, sz) {
    return {
      v: (v === undefined || v === null || v === '') ? '' : v,
      t: typeof v === 'number' ? 'n' : 's',
      s: {
        fill: fillRgb ? { patternType:'solid', fgColor:{ rgb: fillRgb } } : { patternType:'none' },
        font: { name:'Calibri', sz: sz||10, bold: !!bold, color:{ rgb: colorRgb||'111111' } },
        alignment: { horizontal: alignH||'center', vertical:'center' },
        border: {
          top:   { style:'thin', color:{rgb:'CCCCCC'} },
          bottom:{ style:'thin', color:{rgb:'CCCCCC'} },
          left:  { style:'thin', color:{rgb:'CCCCCC'} },
          right: { style:'thin', color:{rgb:'CCCCCC'} }
        }
      }
    };
  }

  function sc(ws, r, c, v, fill, color, bold, align, sz) {
    const addr = XLSX.utils.encode_cell({r, c});
    ws[addr] = mc(v, fill, color, bold, align, sz);
    const cur = ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']) : {s:{r:9999,c:9999},e:{r:0,c:0}};
    if (r < cur.s.r) cur.s.r = r;
    if (c < cur.s.c) cur.s.c = c;
    if (r > cur.e.r) cur.e.r = r;
    if (c > cur.e.c) cur.e.c = c;
    ws['!ref'] = XLSX.utils.encode_range(cur);
  }

  // ‚ïê‚ïê FOGLIO SINTESI ‚ïê‚ïê
  function buildSintesi() {
    const ws = { '!merges':[], '!rows':[], '!cols':[] };
    const lista = [...edili, ...metalmeccanici];
    const nC = 9;

    // Titolo
    ws['!merges'].push({ s:{r:0,c:0}, e:{r:0,c:nC-1} });
    for (let c=0; c<nC; c++) sc(ws, 0, c, c===0 ? `KE CANTIERE ‚Äî PRESENZE ${monthLabel.toUpperCase()}` : '', '0D5C2E','FFFFFF',true,'center',14);

    // Sottotitolo
    ws['!merges'].push({ s:{r:1,c:0}, e:{r:1,c:nC-1} });
    for (let c=0; c<nC; c++) sc(ws, 1, c, c===0 ? `Esportato il ${new Date().toLocaleDateString('it-IT')}` : '', '1A7A3C','CCFFDD',false,'center',10);

    // Spazio
    for (let c=0; c<nC; c++) sc(ws, 2, c, '', 'F8F8F8','F8F8F8',false,'center',4);

    // Header
    const hdrs = ['Matr.','Nome','Contratto','Mansione','GG Pres.','GG Ass.','Ore Ord.','Straord.','Ore Tot.'];
    const hFills = ['333333','333333','333333','333333','1A7A3C','7A1A1A','0D5C2E','7A4A00','0A4A24'];
    hdrs.forEach((h,c) => sc(ws, 3, c, h, hFills[c],'FFFFFF',true, c<4?'left':'center', 11));

    // Dati
    let tP=0, tA=0, tO=0, tS=0;
    lista.forEach((o, i) => {
      const r = 4 + i;
      const g = db.giornate.filter(x => x.operaio===o.id && x.data.startsWith(monthVal));
      const pres = g.filter(x => x.presente);
      const ass  = g.filter(x => !x.presente);
      const oreO = pres.reduce((a,x) => a+(x.ore||0), 0);
      const str  = pres.reduce((a,x) => a+(x.straordinari||0), 0);
      tP+=pres.length; tA+=ass.length; tO+=oreO; tS+=str;

      const bg = i%2===0 ? 'F4FBF7' : 'FFFFFF';
      const bgN = i%2===0 ? 'EAF7EF' : 'F4FBF7';
      const isCE = o.contratto==='cassa_edile';
      sc(ws, r, 0, o.matr||'', bg,'888888',false,'center',10);
      sc(ws, r, 1, titleCase(o.name), bg,'111111',true,'left',11);
      sc(ws, r, 2, isCE?'Cassa Edile':'Metalmeccanico', bg, isCE?'1A7A3C':'1E40AF',true,'left',10);
      sc(ws, r, 3, o.mansione||'', bg,'666666',false,'left',10);
      sc(ws, r, 4, pres.length, bgN, pres.length>0?'155724':'888888', pres.length>0,'center',10);
      sc(ws, r, 5, ass.length,  bgN, ass.length>0?'B71C1C':'888888', ass.length>0,'center',10);
      sc(ws, r, 6, oreO, bgN,'0D5C2E', oreO>0,'center',10);
      sc(ws, r, 7, str,  bgN, str>0?'B45309':'888888', str>0,'center',10);
      sc(ws, r, 8, oreO+str, bgN,'0D5C2E',true,'center',11);
    });

    // Totale
    const rT = 4 + lista.length;
    sc(ws, rT, 0, '', '0D5C2E','FFFFFF',true,'center',10);
    sc(ws, rT, 1, 'TOTALE','0D5C2E','FFFFFF',true,'left',12);
    sc(ws, rT, 2, '','0D5C2E','FFFFFF',true,'center',10);
    sc(ws, rT, 3, '','0D5C2E','FFFFFF',true,'center',10);
    sc(ws, rT, 4, tP,'0D5C2E','AAFFD0',true,'center',12);
    sc(ws, rT, 5, tA,'0D5C2E','FFB3B3',true,'center',12);
    sc(ws, rT, 6, tO,'0D5C2E','AAFFD0',true,'center',12);
    sc(ws, rT, 7, tS,'0D5C2E', tS>0?'FFD580':'AAFFD0',true,'center',12);
    sc(ws, rT, 8, tO+tS,'0A4A24','FFFFFF',true,'center',13);

    ws['!rows'] = [{hpt:30},{hpt:16},{hpt:6},{hpt:22}];
    for (let i=0; i<=lista.length; i++) ws['!rows'].push({hpt:20});
    ws['!cols'] = [{wch:7},{wch:32},{wch:16},{wch:18},{wch:11},{wch:11},{wch:11},{wch:11},{wch:11}];
    return ws;
  }

  // ‚ïê‚ïê FOGLIO DETTAGLIO ‚ïê‚ïê
  function buildDettaglio(lista, label) {
    const ws = { '!merges':[], '!rows':[], '!cols':[] };
    const fN = 3; // colonne fisse: Matr, Nome, Mans
    const sN = 5; // colonne sommario: P, A, Ore, St, Tot
    const nC = fN + daysInMonth + sN;

    // Titolo
    ws['!merges'].push({ s:{r:0,c:0}, e:{r:0,c:nC-1} });
    for (let c=0; c<nC; c++) sc(ws, 0, c, c===0?`KE CANTIERE ‚Äî ${label.toUpperCase()} ‚Äî ${monthLabel.toUpperCase()}`:'','0D5C2E','FFFFFF',true,'center',13);

    // Riga giorno settimana
    sc(ws, 1, 0,'','1E1E1E','1E1E1E',false,'center',8);
    sc(ws, 1, 1,'','1E1E1E','1E1E1E',false,'center',8);
    sc(ws, 1, 2,'','1E1E1E','1E1E1E',false,'center',8);
    for (let i=0; i<daysInMonth; i++) {
      const dow = getDow(allDays[i]);
      const we = dow===0||dow===6;
      sc(ws, 1, fN+i, DOW[dow], we?'5C1A1A':'1E1E1E', we?'FF9999':'999999',true,'center',8);
    }
    const sColors=['1A7A3C','7A1A1A','0D5C2E','7A4A00','0A4A24'];
    for (let i=0; i<sN; i++) sc(ws, 1, fN+daysInMonth+i,'', sColors[i],'AAFFD0',true,'center',8);

    // Header colonne
    sc(ws, 2, 0,'Matr.','222222','FFFFFF',true,'center',10);
    sc(ws, 2, 1,'Nome','222222','FFFFFF',true,'left',11);
    sc(ws, 2, 2,'Mans.','222222','FFFFFF',true,'left',10);
    for (let i=0; i<daysInMonth; i++) {
      const dow = getDow(allDays[i]);
      const we = dow===0||dow===6;
      sc(ws, 2, fN+i, i+1, we?'6B2121':'1A7A3C','FFFFFF',true,'center',9);
    }
    ['P','A','Ore','St.','Tot.'].forEach((lb,i) => sc(ws, 2, fN+daysInMonth+i, lb, sColors[i],'FFFFFF',true,'center',10));

    // Dati
    const totD = new Array(daysInMonth).fill(0);
    let tP=0,tA=0,tO=0,tS=0;

    lista.forEach((o, oi) => {
      const r = 3 + oi;
      const giornate = db.giornate.filter(g => g.operaio===o.id && g.data.startsWith(monthVal));
      const gg = {};
      giornate.forEach(g => { gg[g.data]=g; });
      let gP=0,gA=0,oO=0,oS=0;
      const bg = oi%2===0?'F9FFFE':'FFFFFF';
      const bgS = oi%2===0?'EAF7EF':'F4FBF7';

      sc(ws, r, 0, o.matr||'', bg,'999999',false,'center',9);
      sc(ws, r, 1, titleCase(o.name), bg,'111111',true,'left',11);
      sc(ws, r, 2, o.mansione||'', bg,'666666',false,'left',9);

      for (let i=0; i<daysInMonth; i++) {
        const d = allDays[i];
        const g = gg[d];
        const dow = getDow(d);
        const we = dow===0||dow===6;
        if (!g) {
          sc(ws, r, fN+i, '', we?'F5E8E8':'F5F5F5', we?'DDAAAA':'DDDDDD',false,'center',9);
        } else if (g.presente) {
          const h = (g.ore||0)+(g.straordinari||0);
          gP++; oO+=g.ore||0; oS+=g.straordinari||0; totD[i]+=h;
          sc(ws, r, fN+i, h,'D4EDDA','155724',true,'center',10);
        } else {
          gA++;
          sc(ws, r, fN+i, (g.motivoTipo||'A').substring(0,1).toUpperCase(),'FDECEA','B71C1C',true,'center',9);
        }
      }
      tP+=gP; tA+=gA; tO+=oO; tS+=oS;
      sc(ws, r, fN+daysInMonth+0, gP, bgS, gP>0?'155724':'888888', gP>0,'center',10);
      sc(ws, r, fN+daysInMonth+1, gA, bgS, gA>0?'B71C1C':'888888', gA>0,'center',10);
      sc(ws, r, fN+daysInMonth+2, oO, bgS,'0D5C2E', oO>0,'center',10);
      sc(ws, r, fN+daysInMonth+3, oS, bgS, oS>0?'B45309':'888888', oS>0,'center',10);
      sc(ws, r, fN+daysInMonth+4, oO+oS, bgS,'0D5C2E',true,'center',11);
    });

    // Riga totale
    const rT = 3 + lista.length;
    sc(ws, rT, 0, '','0D5C2E','FFFFFF',true,'center',10);
    sc(ws, rT, 1, 'TOTALE','0D5C2E','FFFFFF',true,'left',12);
    sc(ws, rT, 2, '','0D5C2E','FFFFFF',true,'center',10);
    for (let i=0; i<daysInMonth; i++) {
      const v = totD[i];
      sc(ws, rT, fN+i, v>0?v:'','0D5C2E', v>0?'AAFFD0':'4A7A5A', v>0,'center',10);
    }
    sc(ws, rT, fN+daysInMonth+0, tP,'0A4A24','AAFFD0',true,'center',12);
    sc(ws, rT, fN+daysInMonth+1, tA,'0A4A24','FFB3B3',true,'center',12);
    sc(ws, rT, fN+daysInMonth+2, tO,'0A4A24','AAFFD0',true,'center',12);
    sc(ws, rT, fN+daysInMonth+3, tS,'0A4A24', tS>0?'FFD580':'AAFFD0',true,'center',12);
    sc(ws, rT, fN+daysInMonth+4, tO+tS,'071F10','FFFFFF',true,'center',13);

    ws['!rows'] = [{hpt:26},{hpt:13},{hpt:21}];
    for (let i=0; i<=lista.length; i++) ws['!rows'].push({hpt:19});
    ws['!cols'] = [{wch:6},{wch:28},{wch:12}, ...allDays.map(()=>({wch:4})), {wch:5},{wch:5},{wch:7},{wch:5},{wch:7}];
    ws['!ref'] = XLSX.utils.encode_range({ s:{r:0,c:0}, e:{r:3+lista.length, c:nC-1} });
    return ws;
  }

  // ‚îÄ‚îÄ Componi workbook ‚îÄ‚îÄ
  const wb = XLSX.utils.book_new();
  const wsSin = buildSintesi();
  wsSin['!ref'] = XLSX.utils.encode_range({ s:{r:0,c:0}, e:{r:4+operaiAttivi.length, c:8} });
  XLSX.utils.book_append_sheet(wb, wsSin, 'Sintesi');
  XLSX.utils.book_append_sheet(wb, buildDettaglio(edili, 'Cassa Edile'), 'Cassa Edile');
  XLSX.utils.book_append_sheet(wb, buildDettaglio(metalmeccanici, 'Metalmeccanico'), 'Metalmeccanico');

  const filename = `Presenze_${monthVal.replace('-','_')}.xlsx`;
  XLSX.writeFile(wb, filename);
  toast(`‚úì Export ${filename}`);
}

function initPresenze() {
  document.getElementById('presenza-date').value = todayStr();
  renderPresenze();
}

function renderPresenze() {
  const data = document.getElementById('presenza-date').value;
  const filtro = document.getElementById('presenza-filter').value;
  const container = document.getElementById('presenze-content');
  const summary = document.getElementById('pres-summary');

  // Carica dati salvati per questa data nel DB
  const savedByOp = {};
  db.giornate.filter(g => g.data === data).forEach(g => { savedByOp[g.operaio] = g; });

  // Ricostruisci stato da DB se non gi√† in memoria per questa data
  const stateKey = 'pres_date_' + data;
  if (presenzeState.__date !== data) {
    presenzeState = { __date: data };
    db.operai.filter(o => o.stato === 'attivo').forEach(o => {
      const g = savedByOp[o.id];
      presenzeState[o.id] = g ? {
        stato: g.presente ? 'presente' : 'assente',
        ore: g.ore || 8,
        straord: g.straordinari || 0,
        cantiere: g.cantiere || '',
        motivoTipo: g.motivoTipo || '',
        motivoNote: g.motivoNote || ''
      } : {
        stato: null, ore: 8, straord: 0,
        cantiere: db.cantieri.find(c => c.stato==='attivo')?.id || '',
        motivoTipo: '', motivoNote: ''
      };
    });
  }

  let operai = db.operai.filter(o => o.stato === 'attivo');
  if (filtro) operai = operai.filter(o => o.contratto === filtro);

  // Summary
  const totali = db.operai.filter(o => o.stato === 'attivo').length;
  const presenti = Object.values(presenzeState).filter(s => s && s.stato === 'presente').length;
  const assenti = Object.values(presenzeState).filter(s => s && s.stato === 'assente').length;
  const nonMarcati = totali - presenti - assenti;
  const oreTotal = Object.values(presenzeState).filter(s => s && s.stato === 'presente').reduce((acc, s) => acc + (parseFloat(s.ore)||0) + (parseFloat(s.straord)||0), 0);

  summary.innerHTML = `
    <div class="pres-sum-chip green"><strong>${presenti}</strong> Presenti</div>
    <div class="pres-sum-chip red"><strong>${assenti}</strong> Assenti</div>
    <div class="pres-sum-chip"><strong>${nonMarcati}</strong> Non marcati</div>
    <div class="pres-sum-chip"><strong>${oreTotal}</strong> Ore totali</div>
  `;

  const cantOpts = db.cantieri.filter(c => c.stato === 'attivo').map(c => `<option value="${c.id}">${c.name}</option>`).join('');

  container.innerHTML = operai.map(o => {
    const s = presenzeState[o.id] || { stato: null, ore: 8, straord: 0, cantiere: '', motivoTipo: '', motivoNote: '' };
    const isPresente = s.stato === 'presente';
    const isAssente = s.stato === 'assente';

    return `
    <div class="op-card ${isPresente ? 'presente' : isAssente ? 'assente' : ''}" id="opcard-${o.id}">
      <div class="op-card-accent"></div>
      <div class="op-card-top">
        <div class="op-card-info">
          <div class="op-card-name">${titleCase(o.name)}</div>
          <div class="op-card-sub">
            ${o.matr ? `Matr. ${o.matr} ¬∑ ` : ''}
            <span style="color:${o.contratto==='cassa_edile'?'#86efac':'var(--blue)'}">${o.contratto==='cassa_edile'?'Cassa Edile':'Metalmeccanico'}</span>
            ${o.mansione ? ' ¬∑ ' + o.mansione : ''}
          </div>
        </div>
        <div class="pres-toggle">
          <button onclick="setStato('${o.id}','presente')" class="${isPresente ? 'sel-presente' : ''}">‚úì Presente</button>
          <button onclick="setStato('${o.id}','assente')" class="${isAssente ? 'sel-assente' : ''}">‚úï Assente</button>
        </div>
      </div>

      <div class="op-card-body ${!isPresente ? 'hidden' : ''}" id="body-presente-${o.id}">
        <div class="ore-stepper">
          <div class="ore-stepper-label">Ore lavorate</div>
          <div class="ore-stepper-ctrl">
            <button onclick="changeOre('${o.id}','ore',-0.5)">‚àí</button>
            <span id="ore-val-${o.id}">${s.ore}</span>
            <button onclick="changeOre('${o.id}','ore',+0.5)">+</button>
          </div>
        </div>
        <div class="ore-stepper">
          <div class="ore-stepper-label">Straordinari</div>
          <div class="ore-stepper-ctrl">
            <button onclick="changeOre('${o.id}','straord',-0.5)">‚àí</button>
            <span id="str-val-${o.id}">${s.straord}</span>
            <button onclick="changeOre('${o.id}','straord',+0.5)">+</button>
          </div>
        </div>
        <div class="cantiere-select-wrap">
          <div class="cantiere-select-label">Cantiere</div>
          <select onchange="setCantiere('${o.id}',this.value)">
            <option value="">‚Äî Nessuno ‚Äî</option>
            ${db.cantieri.filter(c=>c.stato==='attivo').map(c=>`<option value="${c.id}" ${s.cantiere===c.id?'selected':''}>${c.name}</option>`).join('')}
          </select>
        </div>
      </div>

      <div class="op-card-assenza ${isAssente ? 'show' : ''}" id="body-assente-${o.id}">
        <div class="assenza-label">Motivo assenza</div>
        <select class="assenza-select" onchange="setMotivo('${o.id}',this.value)">
          <option value="">‚Äî Seleziona motivo ‚Äî</option>
          ${MOTIVI_ASSENZA.map(m=>`<option value="${m.value}" ${s.motivoTipo===m.value?'selected':''}>${m.label}</option>`).join('')}
        </select>
        <textarea class="assenza-note ${s.motivoTipo==='altro'?'show':''}" id="nota-${o.id}" 
          rows="2" placeholder="Note aggiuntive..."
          onchange="setMotivoNote('${o.id}',this.value)">${s.motivoNote||''}</textarea>
      </div>
    </div>
  `}).join('');

  updateSummary();
}

function setStato(opId, stato) {
  if (!presenzeState[opId]) presenzeState[opId] = { stato: null, ore: 8, straord: 0, cantiere: db.cantieri.find(c=>c.stato==='attivo')?.id||'', motivoTipo:'', motivoNote:'' };
  
  // Toggle: cliccare di nuovo = deseleziona
  presenzeState[opId].stato = presenzeState[opId].stato === stato ? null : stato;
  
  const card = document.getElementById('opcard-' + opId);
  const bodyP = document.getElementById('body-presente-' + opId);
  const bodyA = document.getElementById('body-assente-' + opId);
  const btns = card.querySelectorAll('.pres-toggle button');
  const s = presenzeState[opId];

  card.className = 'op-card ' + (s.stato === 'presente' ? 'presente' : s.stato === 'assente' ? 'assente' : '');
  btns[0].className = s.stato === 'presente' ? 'sel-presente' : '';
  btns[1].className = s.stato === 'assente' ? 'sel-assente' : '';
  bodyP.className = 'op-card-body ' + (s.stato === 'presente' ? '' : 'hidden');
  bodyA.className = 'op-card-assenza ' + (s.stato === 'assente' ? 'show' : '');

  updateSummary();
}

function changeOre(opId, tipo, delta) {
  const s = presenzeState[opId];
  if (!s) return;
  const key = tipo; // 'ore' o 'straord'
  const curr = parseFloat(s[key]) || 0;
  const next = Math.max(0, Math.min(24, curr + delta));
  s[key] = next;
  document.getElementById((tipo === 'ore' ? 'ore' : 'str') + '-val-' + opId).textContent = next;
  updateSummary();
}

function setCantiere(opId, val) {
  if (presenzeState[opId]) presenzeState[opId].cantiere = val;
}

function setMotivo(opId, val) {
  if (!presenzeState[opId]) return;
  presenzeState[opId].motivoTipo = val;
  const nota = document.getElementById('nota-' + opId);
  if (nota) nota.className = 'assenza-note ' + (val === 'altro' ? 'show' : '');
}

function setMotivoNote(opId, val) {
  if (presenzeState[opId]) presenzeState[opId].motivoNote = val;
}

function updateSummary() {
  const totali = db.operai.filter(o => o.stato === 'attivo').length;
  const presenti = Object.values(presenzeState).filter(s => s && s.stato === 'presente').length;
  const assenti = Object.values(presenzeState).filter(s => s && s.stato === 'assente').length;
  const nonMarcati = totali - presenti - assenti;
  const oreTotal = Object.values(presenzeState).filter(s => s && s.stato === 'presente').reduce((acc, s) => acc + (parseFloat(s.ore)||0) + (parseFloat(s.straord)||0), 0);
  const summary = document.getElementById('pres-summary');
  if (summary) summary.innerHTML = `
    <div class="pres-sum-chip green"><strong>${presenti}</strong> Presenti</div>
    <div class="pres-sum-chip red"><strong>${assenti}</strong> Assenti</div>
    <div class="pres-sum-chip"><strong>${nonMarcati}</strong> Non marcati</div>
    <div class="pres-sum-chip"><strong>${oreTotal}</strong> Ore totali</div>
  `;
}

function salvaPresenze() {
  const data = document.getElementById('presenza-date').value;
  if (!data) { alert('Seleziona una data'); return; }

  // Rimuovi giornate esistenti per questa data
  db.giornate = db.giornate.filter(g => g.data !== data);

  Object.entries(presenzeState).forEach(([opId, s]) => {
    if (opId === '__date' || !s || !s.stato) return;
    db.giornate.push({
      id: 'g' + Date.now() + opId,
      data, operaio: opId,
      cantiere: s.cantiere || '',
      presente: s.stato === 'presente',
      ore: s.stato === 'presente' ? (parseFloat(s.ore)||8) : 0,
      straordinari: s.stato === 'presente' ? (parseFloat(s.straord)||0) : 0,
      motivoTipo: s.stato === 'assente' ? s.motivoTipo : '',
      motivoNote: s.stato === 'assente' ? (document.getElementById('nota-' + opId)?.value || s.motivoNote || '') : '',
      note: ''
    });
  });

  saveDB();
  renderDashboard();
  toast('Presenze salvate ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEGNALAZIONI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSegnalazioni() {
  const lista = db.segnalazioni;
  const container = document.getElementById('segnalazioni-list');
  if (!lista.length) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">‚öë</div><div class="empty-text">Nessuna segnalazione</div></div>';
    return;
  }
  container.innerHTML = lista.map(s => {
    const cantiere = db.cantieri.find(c => c.id === s.cantiere);
    return `
    <div class="segn-card ${s.priorita === 'alta' ? 'alta' : s.priorita === 'bassa' ? 'bassa' : ''}">
      <div>
        <div class="segn-title">${s.titolo}</div>
        <div class="segn-body">${s.desc || ''}</div>
        <div class="segn-meta">
          <span class="badge badge-${s.priorita === 'alta' ? 'red' : s.priorita === 'bassa' ? 'blue' : 'amber'}" style="margin-right:8px">${s.priorita}</span>
          ${cantiere ? cantiere.name : ''} ‚Äî ${formatDate(s.data)}
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="chiudiSegnalazione('${s.id}')">Chiudi</button>
    </div>
  `}).join('');
}

function openModalSegnalazione() {
  const sel = document.getElementById('segn-cantiere');
  sel.innerHTML = '<option value="">‚Äî Nessuno ‚Äî</option>' + db.cantieri.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('segn-titolo').value = '';
  document.getElementById('segn-desc').value = '';
  document.getElementById('segn-priorita').value = 'media';
  document.getElementById('modal-segnalazione').classList.add('open');
}

function salvaSegnalazione() {
  const titolo = document.getElementById('segn-titolo').value.trim();
  if (!titolo) { alert('Inserisci un titolo'); return; }
  db.segnalazioni.push({
    id: 's' + Date.now(), titolo,
    desc: document.getElementById('segn-desc').value.trim(),
    cantiere: document.getElementById('segn-cantiere').value,
    priorita: document.getElementById('segn-priorita').value,
    data: todayStr(), aperta: true,
  });
  saveDB(); closeModal('modal-segnalazione'); renderSegnalazioni();
  toast('Segnalazione registrata');
}

function chiudiSegnalazione(id) {
  db.segnalazioni = db.segnalazioni.filter(s => s.id !== id);
  saveDB(); renderSegnalazioni(); toast('Segnalazione chiusa');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function titleCase(str) { return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('open'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DIARIO CANTIERE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let diarioFotoBuffer = []; // array di base64

function openModalDiario() {
  diarioFotoBuffer = [];
  document.getElementById('diario-data').value = todayStr();
  const sel = document.getElementById('diario-cantiere');
  sel.innerHTML = db.cantieri.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('diario-desc').value = '';
  document.getElementById('diario-foto-preview').innerHTML = '';
  document.getElementById('diario-foto-input').value = '';
  document.getElementById('modal-diario').classList.add('open');
}

function previewFotoDiario(input) {
  const files = Array.from(input.files);
  const remaining = 5 - diarioFotoBuffer.length;
  if (remaining <= 0) { toast('Massimo 5 foto'); return; }
  const toLoad = files.slice(0, remaining);
  toLoad.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      // Comprimi a max 800px
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX = 800;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else { w = Math.round(w * MAX / h); h = MAX; }
        }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        const b64 = canvas.toDataURL('image/jpeg', 0.75);
        diarioFotoBuffer.push(b64);
        renderFotoPreview();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function renderFotoPreview() {
  document.getElementById('diario-foto-preview').innerHTML = diarioFotoBuffer.map((b64, i) => `
    <div class="preview-thumb">
      <img src="${b64}">
      <button class="rm" onclick="diarioFotoBuffer.splice(${i},1);renderFotoPreview()">‚úï</button>
    </div>
  `).join('');
}

function salvaDiario() {
  const data = document.getElementById('diario-data').value;
  const cantiere = document.getElementById('diario-cantiere').value;
  const desc = document.getElementById('diario-desc').value.trim();
  if (!data) { toast('Seleziona una data'); return; }
  if (!desc && diarioFotoBuffer.length === 0) { toast('Aggiungi almeno una descrizione o una foto'); return; }

  const entry = {
    id: 'd' + Date.now(),
    data,
    cantiere,
    autore: currentUser.username,
    desc,
    foto: [...diarioFotoBuffer],
    ts: new Date().toISOString()
  };

  if (!db.diari) db.diari = [];
  db.diari.push(entry);
  saveDB();
  closeModal('modal-diario');
  renderDiario();
  toast('‚úì Inserimento salvato');
}

function renderDiario() {
  if (!db.diari) db.diari = [];
  const list = document.getElementById('diario-list');
  // Ordina per data decrescente
  const sorted = [...db.diari]
    .filter(d => currentUser.role === 'admin' || d.autore === currentUser.username)
    .sort((a, b) => b.data.localeCompare(a.data));

  if (!sorted.length) {
    list.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">Nessun inserimento. Clicca "+ Nuovo Inserimento" per iniziare.</div>`;
    return;
  }

  list.innerHTML = sorted.map(d => {
    const cant = db.cantieri.find(c => c.id === d.cantiere);
    const dateLabel = new Date(d.data + 'T00:00:00').toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
    const canDelete = currentUser.role === 'admin' || d.autore === currentUser.username;
    return `
      <div class="diario-card">
        <div class="diario-card-header">
          <div>
            <div class="diario-card-date">${dateLabel}</div>
            <div class="diario-card-cantiere">üìç ${cant ? cant.name : 'Cantiere rimosso'}</div>
            <div class="diario-card-autore">üë§ ${d.autore}</div>
          </div>
          ${canDelete ? `<button class="diario-delete-btn" onclick="eliminaDiario('${d.id}')" title="Elimina">‚úï</button>` : ''}
        </div>
        ${d.desc ? `<div class="diario-card-desc">${d.desc.replace(/\n/g,'<br>')}</div>` : ''}
        ${d.foto && d.foto.length ? `
          <div class="diario-foto-grid">
            ${d.foto.map(f => `<img src="${f}" onclick="openLightbox('${f}')" loading="lazy">`).join('')}
          </div>` : ''}
      </div>
    `;
  }).join('');
}

function eliminaDiario(id) {
  if (!confirm('Eliminare questo inserimento?')) return;
  db.diari = (db.diari || []).filter(d => d.id !== id);
  saveDB();
  renderDiario();
  toast('Inserimento eliminato');
}

function openLightbox(src) {
  const lb = document.getElementById('foto-lightbox');
  document.getElementById('foto-lightbox-img').src = src;
  lb.style.display = 'flex';
}

// ‚îÄ‚îÄ‚îÄ Dettaglio cantiere (admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDettaglioCantiere(id) {
  const c = db.cantieri.find(x => x.id === id);
  if (!c) return;
  document.getElementById('cantiere-detail-title').textContent = 'üì∑ ' + c.name + ' ‚Äî Diario';

  const diari = (db.diari || []).filter(d => d.cantiere === id).sort((a,b) => b.data.localeCompare(a.data));
  const content = document.getElementById('cantiere-detail-content');

  if (!diari.length) {
    content.innerHTML = `<div style="text-align:center;padding:32px;color:var(--muted)">Nessun inserimento per questo cantiere.</div>`;
  } else {
    content.innerHTML = diari.map(d => {
      const dateLabel = new Date(d.data + 'T00:00:00').toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
      return `
        <div class="cd-entry">
          <div class="cd-entry-header">
            <div class="cd-entry-autore">üë§ ${d.autore}</div>
            <div class="cd-entry-meta">${dateLabel}</div>
          </div>
          ${d.desc ? `<div class="cd-entry-desc">${d.desc.replace(/\n/g,'<br>')}</div>` : ''}
          ${d.foto && d.foto.length ? `
            <div class="diario-foto-grid">
              ${d.foto.map(f => `<img src="${f}" onclick="openLightbox('${f}')" loading="lazy">`).join('')}
            </div>` : ''}
        </div>
      `;
    }).join('');
  }
  document.getElementById('modal-cantiere-detail').classList.add('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDICONTO OPERAIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rendOpId = null;
let rendCantId = null;

function currMonthVal() {
  const n = new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
}

function apriRendicontoOperaio(id) {
  rendOpId = id;
  const o = db.operai.find(x => x.id === id);
  if (!o) return;
  document.getElementById('rend-op-title').textContent = 'üìã ' + titleCase(o.name);
  document.getElementById('rend-op-month').value = currMonthVal();
  aggiornaRendicontoOperaio();
  document.getElementById('modal-rendiconto-operaio').classList.add('open');
}

function rendMesePrec() {
  const el = document.getElementById('rend-op-month');
  const [y, m] = el.value.split('-').map(Number);
  const d = new Date(y, m - 2, 1);
  el.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  aggiornaRendicontoOperaio();
}
function rendMeseSucc() {
  const el = document.getElementById('rend-op-month');
  const [y, m] = el.value.split('-').map(Number);
  const d = new Date(y, m, 1);
  el.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  aggiornaRendicontoOperaio();
}

function aggiornaRendicontoOperaio() {
  const mese = document.getElementById('rend-op-month').value;
  if (!mese || !rendOpId) return;
  const giornate = db.giornate.filter(g => g.operaio === rendOpId && g.data.startsWith(mese));
  const presenti = giornate.filter(g => g.presente);
  const assenti = giornate.filter(g => !g.presente);
  const oreOrd = presenti.reduce((a, g) => a + (g.ore||0), 0);
  const oreStraord = presenti.reduce((a, g) => a + (g.straordinari||0), 0);

  document.getElementById('rend-op-stats').innerHTML = `
    <div class="rend-stat"><div class="rend-stat-num green">${presenti.length}</div><div class="rend-stat-label">GG Presenti</div></div>
    <div class="rend-stat"><div class="rend-stat-num red">${assenti.length}</div><div class="rend-stat-label">GG Assenti</div></div>
    <div class="rend-stat"><div class="rend-stat-num">${oreOrd}</div><div class="rend-stat-label">Ore Ord.</div></div>
    <div class="rend-stat"><div class="rend-stat-num amber">${oreStraord}</div><div class="rend-stat-label">Straord.</div></div>
    <div class="rend-stat"><div class="rend-stat-num">${oreOrd + oreStraord}</div><div class="rend-stat-label">Ore Totali</div></div>
  `;

  if (!giornate.length) {
    document.getElementById('rend-op-tbody').innerHTML = `<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--muted)">Nessuna giornata registrata per questo mese.</td></tr>`;
    return;
  }

  const sortedGiornate = [...giornate].sort((a, b) => a.data.localeCompare(b.data));
  document.getElementById('rend-op-tbody').innerHTML = sortedGiornate.map(g => {
    const dateLabel = new Date(g.data + 'T00:00:00').toLocaleDateString('it-IT', { weekday:'short', day:'numeric', month:'short' });
    const cant = db.cantieri.find(c => c.id === g.cantiere);
    const cantNome = cant ? cant.name : '‚Äî';
    if (g.presente) {
      const oreT = (g.ore||0) + (g.straordinari||0);
      return `<tr>
        <td>${dateLabel}</td>
        <td><span class="badge badge-green">Presente</span></td>
        <td>${g.ore||0}</td>
        <td>${g.straordinari||0}</td>
        <td style="font-weight:600;color:var(--white)">${oreT}</td>
        <td>${cantNome}</td>
      </tr>`;
    } else {
      const motivo = g.motivoTipo ? g.motivoTipo.charAt(0).toUpperCase() + g.motivoTipo.slice(1) : 'Assente';
      return `<tr>
        <td>${dateLabel}</td>
        <td><span class="badge badge-red">${motivo}</span></td>
        <td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>
        <td>‚Äî</td>
      </tr>`;
    }
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDICONTO CANTIERE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function apriRendicontoCantiere(id) {
  rendCantId = id;
  const c = db.cantieri.find(x => x.id === id);
  if (!c) return;
  document.getElementById('rend-cant-title').textContent = 'üìã ' + c.name;
  document.getElementById('rend-cant-month').value = currMonthVal();
  aggiornaRendicontoCantiere();
  document.getElementById('modal-rendiconto-cantiere').classList.add('open');
}

function rendCantMesePrec() {
  const el = document.getElementById('rend-cant-month');
  const [y, m] = el.value.split('-').map(Number);
  const d = new Date(y, m - 2, 1);
  el.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  aggiornaRendicontoCantiere();
}
function rendCantMeseSucc() {
  const el = document.getElementById('rend-cant-month');
  const [y, m] = el.value.split('-').map(Number);
  const d = new Date(y, m, 1);
  el.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  aggiornaRendicontoCantiere();
}

function aggiornaRendicontoCantiere() {
  const mese = document.getElementById('rend-cant-month').value;
  if (!mese || !rendCantId) return;

  const giornateDelCantiere = db.giornate.filter(g => g.cantiere === rendCantId && g.data.startsWith(mese) && g.presente);
  const operaiCoinvolti = [...new Set(giornateDelCantiere.map(g => g.operaio))];

  let totGGPres = 0, totOreOrd = 0, totStraord = 0;

  const righe = operaiCoinvolti.map(opId => {
    const op = db.operai.find(o => o.id === opId);
    const giornateOp = giornateDelCantiere.filter(g => g.operaio === opId);
    const gg = giornateOp.length;
    const oreOrd = giornateOp.reduce((a, g) => a + (g.ore||0), 0);
    const oreStraord = giornateOp.reduce((a, g) => a + (g.straordinari||0), 0);
    totGGPres += gg; totOreOrd += oreOrd; totStraord += oreStraord;
    // contiamo anche le assenze per questo cantiere? no, le assenze non hanno cantiere
    const contratto = op ? (op.contratto === 'cassa_edile' ? 'Cassa Edile' : 'Metalmeccanico') : '‚Äî';
    const badgeClass = op?.contratto === 'cassa_edile' ? 'badge-amber' : 'badge-blue';
    return `<tr>
      <td style="font-weight:500;color:var(--white)">${op ? titleCase(op.name) : opId}</td>
      <td><span class="badge ${badgeClass}">${contratto}</span></td>
      <td>${gg}</td>
      <td>‚Äî</td>
      <td>${oreOrd}</td>
      <td>${oreStraord}</td>
      <td style="font-weight:600;color:var(--white)">${oreOrd + oreStraord}</td>
    </tr>`;
  });

  document.getElementById('rend-cant-stats').innerHTML = `
    <div class="rend-stat"><div class="rend-stat-num green">${operaiCoinvolti.length}</div><div class="rend-stat-label">Operai</div></div>
    <div class="rend-stat"><div class="rend-stat-num">${totGGPres}</div><div class="rend-stat-label">GG Presenza</div></div>
    <div class="rend-stat"><div class="rend-stat-num">${totOreOrd}</div><div class="rend-stat-label">Ore Ord.</div></div>
    <div class="rend-stat"><div class="rend-stat-num amber">${totStraord}</div><div class="rend-stat-label">Straord.</div></div>
    <div class="rend-stat"><div class="rend-stat-num">${totOreOrd + totStraord}</div><div class="rend-stat-label">Ore Totali</div></div>
  `;

  document.getElementById('rend-cant-tbody').innerHTML = righe.length
    ? righe.join('')
    : `<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--muted)">Nessuna presenza registrata per questo cantiere in questo mese.</td></tr>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const now = new Date();
document.getElementById('date-display').textContent = now.toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long', year:'numeric' });

// Render solo se gi√† loggato (sessione attiva)
if (currentUser) {
  renderDashboard();
  initPresenze();
} else {
  // Focus sul campo username
  setTimeout(() => document.getElementById('login-username').focus(), 100);
}
</script>
</body>
</html>
